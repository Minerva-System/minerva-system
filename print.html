<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Minerva System</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introdução</a></li><li class="chapter-item expanded "><a href="CHANGELOG.html"><strong aria-hidden="true">2.</strong> Changelog</a></li><li class="chapter-item expanded "><a href="estrutura.html"><strong aria-hidden="true">3.</strong> Estrutura geral do projeto</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> Front-End</div></li><li class="chapter-item expanded "><a href="backend.html"><strong aria-hidden="true">3.2.</strong> Back-End</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Regras de Negócio</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="documentacao.html"><strong aria-hidden="true">4.1.</strong> Documentação do Projeto</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Cache de Sessão via Redis</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.</strong> Diagramas</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="diagramas/casos-de-uso.html"><strong aria-hidden="true">4.3.1.</strong> Diagramas de Caso de Uso</a></li><li class="chapter-item expanded "><a href="diagramas-sequencia.html"><strong aria-hidden="true">4.3.2.</strong> Diagramas de Sequência</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.1.</strong> Inquilinos (TENANCY)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.1.1.</strong> Listagem de nomes de inquilinos</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.1.2.</strong> Listagem de inquilinos</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.1.3.</strong> Criar inquilino</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.1.4.</strong> Desativar inquilino</div></li></ol></li><li class="chapter-item expanded "><a href="diagramas-sequencia-sessao.html"><strong aria-hidden="true">4.3.2.2.</strong> Sessão (SESSION)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="diagramas/login.html"><strong aria-hidden="true">4.3.2.2.1.</strong> Login do usuário</a></li><li class="chapter-item expanded "><a href="diagramas/logoff.html"><strong aria-hidden="true">4.3.2.2.2.</strong> Logoff do usuário</a></li></ol></li><li class="chapter-item expanded "><a href="diagramas-sequencia-usuarios.html"><strong aria-hidden="true">4.3.2.3.</strong> Usuários (USER)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="diagramas/cadastro-usuarios.html"><strong aria-hidden="true">4.3.2.3.1.</strong> Cadastro de usuários</a></li><li class="chapter-item expanded "><a href="diagramas/lista-usuarios.html"><strong aria-hidden="true">4.3.2.3.2.</strong> Listagem de usuários</a></li><li class="chapter-item expanded "><a href="diagramas/consultar-usuarios.html"><strong aria-hidden="true">4.3.2.3.3.</strong> Consultar usuário</a></li><li class="chapter-item expanded "><a href="diagramas/alteracao-usuarios.html"><strong aria-hidden="true">4.3.2.3.4.</strong> Alteração de cadastro de usuários</a></li><li class="chapter-item expanded "><a href="diagramas/remocao-usuarios.html"><strong aria-hidden="true">4.3.2.3.5.</strong> Remoção de usuários</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.</strong> Produtos (PRODUCT)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.1.</strong> Cadastro de produtos</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.2.</strong> Listagem de produtos</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.3.</strong> Consultar produto</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.4.</strong> Alteração de cadastro de produtos</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.4.5.</strong> Remoção de produtos</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.</strong> Estoque (STOCK)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.1.</strong> Início de estoque</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.2.</strong> Consulta de estoque</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.3.</strong> Listagem de estoques</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.4.</strong> Entrada de estoque</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.5.</strong> Saída de estoque</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.5.6.</strong> Listagem de movimentações de um estoque</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.6.</strong> Relatórios (REPORT)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.6.1.</strong> Listagem de Entidades na tela</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.6.2.</strong> Listagem de Entidades em PDF</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.</strong> Clientes (CLIENT)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.1.</strong> Cadastro de clientes</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.2.</strong> Listagem de clientes</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.3.</strong> Consultar cliente</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.4.</strong> Alteração de cadastro de cliente</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.7.5.</strong> Remoção de clientes</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.8.</strong> Auditoria (AUDIT)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.8.1.</strong> Consultar logs de auditoria</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.9.</strong> Comunicação Instantânea (COMM)</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.9.1.</strong> Enviar mensagem via WhatsApp</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.9.2.</strong> Enviar mensagem via Facebook Messenger</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.9.3.</strong> Enviar mensagem via Instagram</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.3.2.9.4.</strong> Enviar mensagem via Telegram</div></li></ol></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="multi-tenancy.html"><strong aria-hidden="true">5.</strong> Multi-Tenancy</a></li><li class="chapter-item expanded "><a href="banco-relacional.html"><strong aria-hidden="true">6.</strong> Banco de Dados Relacional</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="migrations.html"><strong aria-hidden="true">6.1.</strong> Executando migrations</a></li></ol></li><li class="chapter-item expanded "><a href="banco-nao-relacional.html"><strong aria-hidden="true">7.</strong> Banco de Dados Não-Relacional</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="colecoes.html"><strong aria-hidden="true">7.1.</strong> Coleções</a></li></ol></li><li class="chapter-item expanded "><a href="compilacao.html"><strong aria-hidden="true">8.</strong> Compilação</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="executar-maquina.html"><strong aria-hidden="true">8.1.</strong> Executar com recursos da máquina</a></li><li class="chapter-item expanded "><a href="gerando-imagens.html"><strong aria-hidden="true">8.2.</strong> Gerando imagens via Docker</a></li></ol></li><li class="chapter-item expanded "><a href="deploy.html"><strong aria-hidden="true">9.</strong> Deploy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deploy-compose.html"><strong aria-hidden="true">9.1.</strong> Deploy via Docker Compose</a></li><li class="chapter-item expanded "><a href="deploy-swarm.html"><strong aria-hidden="true">9.2.</strong> Deploy via Docker Swarm + Vagrant</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deploy-swarm-machine.html"><strong aria-hidden="true">9.2.1.</strong> Deploy via Docker Swarm + Docker Machine</a></li></ol></li><li class="chapter-item expanded "><a href="deploy-kubernetes.html"><strong aria-hidden="true">9.3.</strong> Deploy via Kubernetes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="diagramas/estrutura-kubernetes.html"><strong aria-hidden="true">9.3.1.</strong> Estrutura geral do cluster</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Minerva System</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introdução"><a class="header" href="#introdução">Introdução</a></h1>
<center>
<p><img src="./minerva-logo.png" alt="Logomarca do Sistema Minerva" /></p>
</center>
<p>Este documento trata da especificação funcional do Sistema Minerva. O sistema
é majoritariamente programado utilizando o método eXtreme Programming, portanto
esta documentação não é exaustiva no sentido de uma especificação completa,
posto que os requisitos do sistema estarão em constante mudança.</p>
<p>A modificação deste documento é enormemente encorajada, mas é mais importante a
prototipação constante do sistema que a escrita da especificação propriamente
dita.</p>
<p>Para mitigar os problemas que podem ocorrer mediante foco diminuído neste
documento, recomenda-se um grande uso de testes unitários e também de documentação
<em>ad-hoc</em> no código dos módulos do projeto, de preferência envolvendo as ferramentas
padrão da linguagem.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="changelog"><a class="header" href="#changelog">Changelog</a></h1>
<p>Todas as mudanças notáveis neste projeto serão documentadas nesse arquivo.</p>
<p>O formato é baseado em <a href="https://keepachangelog.com/pt-BR/1.0.0/">Keep a Changelog</a>,
e este projeto adere ao <a href="https://semver.org/spec/v2.0.0.html">Versionamento Semântico</a>.</p>
<h2 id="não-lançado"><a class="header" href="#não-lançado"><a href="https://github.com/luksamuk/minerva-system/compare/v1...HEAD">Não-lançado</a></a></h2>
<h3 id="geral"><a class="header" href="#geral">Geral</a></h3>
<p>Relação de versões de microsserviços:</p>
<ul>
<li><code>USER</code> - v0.2.2</li>
<li><code>SESSION</code> - v0.1.2</li>
<li><code>RUNONCE</code> - v0.2.1</li>
<li><code>REST</code> - v0.2.2</li>
<li>Front-End - v0.1.1 (pré-alfa)</li>
</ul>
<h4 id="adicionado"><a class="header" href="#adicionado">Adicionado</a></h4>
<ul>
<li>Adição de diagramas iniciais de caso de uso e sequência;</li>
<li>Adição de CHANGELOG e regras de versionamento semântico.</li>
</ul>
<h4 id="modificado"><a class="header" href="#modificado">Modificado</a></h4>
<ul>
<li>Imagens Docker agora são geradas usando Alpine Linux como base, reduzindo
tamanho e <em>footprint</em> em <em>deploys</em> no Compose/Swarm/Kubernetes.</li>
</ul>
<h4 id="consertado"><a class="header" href="#consertado">Consertado</a></h4>
<ul>
<li>Problema na exportação de diagramas usando PlantUML no Github Pages.</li>
</ul>
<h4 id="removido"><a class="header" href="#removido">Removido</a></h4>
<ul>
<li>Dependência da <em>crate</em> <code>rustc-serialize</code> na configuração da <em>crate</em>
<code>chrono</code> (em confirmidade com alerta Dependabot), para todos os módulos.</li>
</ul>
<h3 id="rest---v022"><a class="header" href="#rest---v022"><code>REST</code> - v0.2.2</a></h3>
<h4 id="adicionado-1"><a class="header" href="#adicionado-1">Adicionado</a></h4>
<ul>
<li><em>Catchers</em> para tipos de retorno comuns e retorno genérico padrão.</li>
</ul>
<h4 id="consertado-1"><a class="header" href="#consertado-1">Consertado</a></h4>
<ul>
<li>Erros na conexão com um microsserviço agora retornam um erro 503 (Recurso
Indisponível).</li>
</ul>
<h3 id="user---v022"><a class="header" href="#user---v022"><code>USER</code> - v0.2.2</a></h3>
<h4 id="modificado-1"><a class="header" href="#modificado-1">Modificado</a></h4>
<ul>
<li>Alteração do nome do serviço de <code>USERS</code> para <code>USER</code>, evitando maiores
enganos.</li>
</ul>
<h3 id="session---v012"><a class="header" href="#session---v012"><code>SESSION</code> - v0.1.2</a></h3>
<h4 id="modificado-2"><a class="header" href="#modificado-2">Modificado</a></h4>
<ul>
<li>Alteração do serviço para abrigar uso de <em>cache</em> via Redis.</li>
</ul>
<h2 id="v1---2022-06-17"><a class="header" href="#v1---2022-06-17"><a href="https://github.com/luksamuk/minerva-system/releases/tag/v1">v1</a> - 2022-06-17</a></h2>
<h3 id="geral-1"><a class="header" href="#geral-1">Geral</a></h3>
<p>Relação de versões de microsserviços:</p>
<ul>
<li><code>USERS</code> - v0.2.1</li>
<li><code>SESSION</code> - v0.1.1</li>
<li><code>RUNONCE</code> - v0.2.0</li>
<li><code>REST</code> - v0.2.0</li>
<li>Front-End - v0.0.1 (pré-alfa)</li>
</ul>
<h4 id="adicionado-2"><a class="header" href="#adicionado-2">Adicionado</a></h4>
<ul>
<li>Criação de schemas do banco de dados relacional (PostgreSQL 14);</li>
<li>Criação das coleções do banco de dados não-relacional (MongoDB 5);</li>
<li>Adição de <em>protocol buffers</em>;</li>
<li>Adição do microsserviço gRPC <code>USERS</code>;</li>
<li>Adição do microsserviço gRPC <code>SESSION</code>;</li>
<li>Adição da base para alguns outros microsserviços;</li>
<li>Adição da documentação básica;</li>
<li>Adição das bibliotecas <code>DATA</code> e <code>RPC</code>;</li>
<li>Adição do microsserviço gRPC <code>REST</code> (Rocket v0.5.0-rc.2);</li>
<li>Adição de rotas de autenticação e CRUD de usuários;</li>
<li>Adição de <em>pooling</em> de conexões com o banco de dados não-relacional;</li>
<li>Adição de <em>logs</em> para operações de CRUD de usuários e de sessão;</li>
<li>Adição de configuração de teste para Docker Compose;</li>
<li>Adição de configuração de deploy para Docker Swarm;</li>
<li>Adição de configuração de deploy para Kubernetes;</li>
<li>Adição de conceito básico de Front-End (com Flutter 3.0);</li>
<li>Adição de automatização de testes;</li>
<li>Adição de geração de documentação (mdBook, <code>cargo doc</code>, <code>flutter doc</code>)
via GitHub Pages.</li>
</ul>
<!-- ==== Exemplo ==== -->
<!-- ## [v1] - 2022-06-17 -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<!-- ### `USERS` - [v0.2.1] -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<!-- ### `SESSION` - [v0.1.1] -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<!-- ### `RUNONCE` - [v0.2.0] -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<!-- ### `REST` - [v0.2.0] -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<!-- ### Front-End - [v0.0.1] - (pré-alfa) -->
<!-- #### Adicionado -->
<!-- #### Modificado -->
<!-- #### Consertado -->
<!-- #### Removido -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="estrutura-geral-do-projeto"><a class="header" href="#estrutura-geral-do-projeto">Estrutura geral do projeto</a></h1>
<p>O projeto Minerva é uma aplicação pensada com finalidade de estudo, mas que
não deixa de ser um sistema real e com um público alvo. Sendo assim, trata-se
de um sistema gerencial pensado para pequenos negócios, <em>sem finalidade comercial</em>.</p>
<p>O projeto envolve um licenciamento de Software Livre, e busca implementar uma
estrutura de microsserviços. Em outras palavras, o sistema opera através da modificação
de uma única base de dados, mas possui modulos separados para modificação de partes
específicas.</p>
<p>Minerva também utiliza uma dicotomia front-end/back-end, de forma que a aplicação
constitui-se de uma interface gráfica web, acessível via navegador, e uma intraestrutura
constituída de um ponto de entrada que se comunica com os serviços específicos que
a interface gráfica requisitar.</p>
<h2 id="serviços"><a class="header" href="#serviços">Serviços</a></h2>
<p>Como supracitado, Minerva constitui-se de microsserviços, especialmente em seu back-end.
Para tanto, deve-se pensar em três grandes serviços:</p>
<ul>
<li>Front-End (aplicação web envolvendo interface gráfica, feita em alguma tecnologia
para tal, como Flutter);</li>
<li>Back-End (aplicação com ponto de entrada REST, constituída de microsserviços, com
comunicação interna via gRPC);</li>
<li>Banco de Dados (PostgreSQL 14, que pode ser utilizado em um contêiner Docker para
intuitos de debug apenas).</li>
</ul>
<p>Adicionalmente, será possível manter uma maleabilidade que permita a confecção de outros
tipos de Front-Ends que se comuniquem diretamente com o Back-End da aplicação, como
por exemplo, através de programas nativos para Desktop e Mobile.</p>
<center>
<div><!-- Generated by graphviz version 2.50.0 (0)
 --><!-- Pages: 1 --><svg width="365pt" height="228pt"
 viewBox="0.00 0.00 364.50 228.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 224)"><g id="clust2" class="cluster"><title>cluster_webservice</title><polygon fill="#666666" stroke="black" points="8,-98 8,-212 348.5,-212 348.5,-98 8,-98"/><text text-anchor="middle" x="178.25" y="-196.8" font-family="Times,serif" font-size="14.00">Serviço Web</text></g><g id="clust3" class="cluster"><title>cluster_internal</title><polygon fill="#999999" stroke="black" points="164.5,-106 164.5,-181 340.5,-181 340.5,-106 164.5,-106"/><text text-anchor="middle" x="252.5" y="-165.8" font-family="Times,serif" font-size="14.00">Interno</text></g><!-- frontend --><g id="node1" class="node"><title>frontend</title><polygon fill="lightgrey" stroke="black" points="120,-150 16,-150 16,-114 126,-114 126,-144 120,-150"/><polyline fill="none" stroke="black" points="120,-150 120,-144 "/><polyline fill="none" stroke="black" points="126,-144 120,-144 "/><text text-anchor="middle" x="71" y="-128.3" font-family="Times,serif" font-size="14.00">Front&#45;End (Web)</text></g><!-- backend --><g id="node2" class="node"><title>backend</title><polygon fill="lightgrey" stroke="black" points="242.5,-150 176.5,-150 172.5,-146 172.5,-114 238.5,-114 242.5,-118 242.5,-150"/><polyline fill="none" stroke="black" points="238.5,-146 172.5,-146 "/><polyline fill="none" stroke="black" points="238.5,-146 238.5,-114 "/><polyline fill="none" stroke="black" points="238.5,-146 242.5,-150 "/><text text-anchor="middle" x="207.5" y="-128.3" font-family="Times,serif" font-size="14.00">Back&#45;End</text></g><!-- frontend&#45;&#45;backend --><g id="edge3" class="edge"><title>frontend&#45;&#45;backend</title><path fill="none" stroke="darkorange" d="M126.32,-132C141.92,-132 158.49,-132 172.49,-132"/></g><!-- db --><g id="node3" class="node"><title>db</title><path fill="lightgrey" stroke="black" d="M332.5,-146.73C332.5,-148.53 320.4,-150 305.5,-150 290.6,-150 278.5,-148.53 278.5,-146.73 278.5,-146.73 278.5,-117.27 278.5,-117.27 278.5,-115.47 290.6,-114 305.5,-114 320.4,-114 332.5,-115.47 332.5,-117.27 332.5,-117.27 332.5,-146.73 332.5,-146.73"/><path fill="none" stroke="black" d="M332.5,-146.73C332.5,-144.92 320.4,-143.45 305.5,-143.45 290.6,-143.45 278.5,-144.92 278.5,-146.73"/><text text-anchor="middle" x="305.5" y="-128.3" font-family="Times,serif" font-size="14.00">BD</text></g><!-- backend&#45;&#45;db --><g id="edge4" class="edge"><title>backend&#45;&#45;db</title><path fill="none" stroke="darkmagenta" d="M242.62,-132C254.36,-132 267.33,-132 278.34,-132"/></g><!-- desktop --><g id="node4" class="node"><title>desktop</title><polygon fill="lightgrey" stroke="black" points="136.5,-90 5.5,-90 5.5,-54 136.5,-54 136.5,-90"/><text text-anchor="middle" x="71" y="-68.3" font-family="Times,serif" font-size="14.00">Front&#45;End (Desktop)</text></g><!-- desktop&#45;&#45;backend --><g id="edge1" class="edge"><title>desktop&#45;&#45;backend</title><path fill="none" stroke="darkorange" stroke-dasharray="5,2" d="M127.13,-90.1C130.32,-91.37 133.47,-92.67 136.5,-94 149.67,-99.77 163.69,-107.13 175.7,-113.82"/></g><!-- mobile --><g id="node5" class="node"><title>mobile</title><polygon fill="lightgrey" stroke="black" points="133.5,-36 8.5,-36 8.5,0 133.5,0 133.5,-36"/><text text-anchor="middle" x="71" y="-14.3" font-family="Times,serif" font-size="14.00">Front&#45;End (Mobile)</text></g><!-- mobile&#45;&#45;backend --><g id="edge2" class="edge"><title>mobile&#45;&#45;backend</title><path fill="none" stroke="darkorange" stroke-dasharray="5,2" d="M122.32,-36.1C127.31,-38.75 132.13,-41.72 136.5,-45 161.91,-64.11 183.49,-94.44 195.72,-113.77"/></g></g></svg></div>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="back-end"><a class="header" href="#back-end">Back-End</a></h1>
<p>O back-end Minerva compõe-se de microsserviços, com uma interface comum de
comunicação externa que seja simples de usar para os padrões atuais.</p>
<p>O back-end compõe-se dos seguintes componentes:</p>
<ol>
<li>Componente de comunicação externa: um serviço composto de rotas, sendo
portanto uma API REST. Este serviço requisita dados sob demanda a cada
serviço, dependendo do recurso que foi requisitado por via externa. É
efetivamente o intermediário entre Minerva e o mundo externo. As
requisições entre este serviço e os outros deverão ser feito através da
abertura de uma requisição gRPC em que este módulo seja o cliente
requisitante; as respostas recebidas via gRPC são então retornadas
como resposta às requisições recebidas via REST, após tratamento para
serialização como JSON.</li>
<li>Componente de usuários: Servidor gRPC responsável por realizar o CRUD
de usuários e por verificar as regras de negócio destas operações.</li>
<li>Componente de sessão: Servidor gRPC responsável por realizar login,
logoff, verificação de senha e gerenciamento de sessão de usuários.</li>
<li>Componente de produtos: Servidor gRPC responsável por realizar o CRUD
de produtos e por verificar as regras de negócio destas operações.</li>
<li>Componente de estoque: Servidor gRPC responsável por realizar regras
de negócios relacionadas a estoque de produtos (início, baixa, lançamento,
etc).</li>
</ol>
<p>Os <strong>serviços gRPC</strong> supracitados tratam-se de servidores gRPC que podem
receber conexões vindas do ponto de entrada REST ou mesmo entre si. Além
disso, os serviços gRPC devem ser capazes de se comunicar com bancos de
dados, que são recursos essenciais para os mesmos (exemplo: PostgreSQL,
Redis). Além disso, <strong>estes serviços devem gravar log de suas operações</strong>,
mais especificamente nas operações de inserção, atualização e exclusão.</p>
<p>Esses componentes possuem análogos programados, mas não são todos os módulos
da aplicação, que também constituem-se de bibliotecas que podem ser utilizadas
e referenciadas entre si.</p>
<style>
svg:not(:root ) {
      max-width: 100%;
	  height: auto;
}
</style>
<center>
<div><!-- Generated by graphviz version 2.50.0 (0)
 --><!-- Pages: 1 --><svg width="656pt" height="377pt"
 viewBox="0.00 0.00 656.00 377.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 373)"><g id="clust1" class="cluster"><title>cluster_db</title><polygon fill="transparent" stroke="darkmagenta" points="310,-8 310,-98 524,-98 524,-8 310,-8"/><text text-anchor="middle" x="417" y="-82.8" font-family="Times,serif" font-size="14.00" fill="darkmagenta">BANCO DE DADOS</text><text text-anchor="middle" x="417" y="-67.8" font-family="Times,serif" font-size="14.00" fill="darkmagenta">(multi&#45;tenant)</text></g><g id="clust3" class="cluster"><title>cluster_backend</title><polygon fill="transparent" stroke="darkred" points="8,-106 8,-325 640,-325 640,-106 8,-106"/><text text-anchor="middle" x="324" y="-309.8" font-family="Times,serif" font-size="14.00" fill="darkred">BACK&#45;END</text></g><!-- frontend --><g id="node1" class="node"><title>frontend</title><polygon fill="transparent" stroke="darkorange" points="363.5,-369 276.5,-369 276.5,-333 369.5,-333 369.5,-363 363.5,-369"/><polyline fill="none" stroke="darkorange" points="363.5,-369 363.5,-363 "/><polyline fill="none" stroke="darkorange" points="369.5,-363 363.5,-363 "/><text text-anchor="middle" x="323" y="-347.3" font-family="Times,serif" font-size="14.00" fill="darkorange">FRONT&#45;END</text></g><!-- rest --><g id="node5" class="node"><title>rest</title><polygon fill="#999999" stroke="green" points="350,-294 300,-294 296,-290 296,-258 346,-258 350,-262 350,-294"/><polyline fill="none" stroke="green" points="346,-290 296,-290 "/><polyline fill="none" stroke="green" points="346,-290 346,-258 "/><polyline fill="none" stroke="green" points="346,-290 350,-294 "/><text text-anchor="middle" x="323" y="-272.3" font-family="Times,serif" font-size="14.00" fill="green">REST</text></g><!-- frontend&#45;&#45;rest --><g id="edge20" class="edge"><title>frontend&#45;&#45;rest</title><path fill="none" stroke="green" stroke-width="2" d="M323,-332.7C323,-321.06 323,-305.79 323,-294.18"/></g><!-- db2 --><g id="node2" class="node"><title>db2</title><path fill="#999999" stroke="darkmagenta" d="M516,-48.73C516,-50.53 503.9,-52 489,-52 474.1,-52 462,-50.53 462,-48.73 462,-48.73 462,-19.27 462,-19.27 462,-17.47 474.1,-16 489,-16 503.9,-16 516,-17.47 516,-19.27 516,-19.27 516,-48.73 516,-48.73"/><path fill="none" stroke="darkmagenta" d="M516,-48.73C516,-46.92 503.9,-45.45 489,-45.45 474.1,-45.45 462,-46.92 462,-48.73"/><text text-anchor="middle" x="489" y="-30.3" font-family="Times,serif" font-size="14.00" fill="darkmagenta">inq3</text></g><!-- db1 --><g id="node3" class="node"><title>db1</title><path fill="#999999" stroke="darkmagenta" d="M444,-48.73C444,-50.53 431.9,-52 417,-52 402.1,-52 390,-50.53 390,-48.73 390,-48.73 390,-19.27 390,-19.27 390,-17.47 402.1,-16 417,-16 431.9,-16 444,-17.47 444,-19.27 444,-19.27 444,-48.73 444,-48.73"/><path fill="none" stroke="darkmagenta" d="M444,-48.73C444,-46.92 431.9,-45.45 417,-45.45 402.1,-45.45 390,-46.92 390,-48.73"/><text text-anchor="middle" x="417" y="-30.3" font-family="Times,serif" font-size="14.00" fill="darkmagenta">inq2</text></g><!-- db3 --><g id="node4" class="node"><title>db3</title><path fill="#999999" stroke="darkmagenta" d="M372,-48.73C372,-50.53 359.9,-52 345,-52 330.1,-52 318,-50.53 318,-48.73 318,-48.73 318,-19.27 318,-19.27 318,-17.47 330.1,-16 345,-16 359.9,-16 372,-17.47 372,-19.27 372,-19.27 372,-48.73 372,-48.73"/><path fill="none" stroke="darkmagenta" d="M372,-48.73C372,-46.92 359.9,-45.45 345,-45.45 330.1,-45.45 318,-46.92 318,-48.73"/><text text-anchor="middle" x="345" y="-30.3" font-family="Times,serif" font-size="14.00" fill="darkmagenta">inq1</text></g><!-- tenancy --><g id="node6" class="node"><title>tenancy</title><polygon fill="#999999" stroke="blue" points="270,-222 192,-222 188,-218 188,-186 266,-186 270,-190 270,-222"/><polyline fill="none" stroke="blue" points="266,-218 188,-218 "/><polyline fill="none" stroke="blue" points="266,-218 266,-186 "/><polyline fill="none" stroke="blue" points="266,-218 270,-222 "/><text text-anchor="middle" x="229" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">TENANCY</text></g><!-- rest&#45;&#45;tenancy --><g id="edge3" class="edge"><title>rest&#45;&#45;tenancy</title><path fill="none" stroke="blue" stroke-width="2" d="M299.76,-257.7C285.19,-246.85 266.49,-232.92 251.97,-222.1"/></g><!-- user --><g id="node7" class="node"><title>user</title><polygon fill="#999999" stroke="blue" points="170,-222 120,-222 116,-218 116,-186 166,-186 170,-190 170,-222"/><polyline fill="none" stroke="blue" points="166,-218 116,-218 "/><polyline fill="none" stroke="blue" points="166,-218 166,-186 "/><polyline fill="none" stroke="blue" points="166,-218 170,-222 "/><text text-anchor="middle" x="143" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">USER</text></g><!-- rest&#45;&#45;user --><g id="edge4" class="edge"><title>rest&#45;&#45;user</title><path fill="none" stroke="blue" stroke-width="2" d="M295.92,-265.84C266.77,-255.79 219.17,-238.84 179,-222 176.07,-220.77 173.03,-219.43 170.01,-218.07"/></g><!-- session --><g id="node8" class="node"><title>session</title><polygon fill="#999999" stroke="blue" points="331.5,-150 264.5,-150 260.5,-146 260.5,-114 327.5,-114 331.5,-118 331.5,-150"/><polyline fill="none" stroke="blue" points="327.5,-146 260.5,-146 "/><polyline fill="none" stroke="blue" points="327.5,-146 327.5,-114 "/><polyline fill="none" stroke="blue" points="327.5,-146 331.5,-150 "/><text text-anchor="middle" x="296" y="-128.3" font-family="Times,serif" font-size="14.00" fill="blue">SESSION</text></g><!-- rest&#45;&#45;session --><g id="edge5" class="edge"><title>rest&#45;&#45;session</title><path fill="none" stroke="blue" stroke-width="2" d="M342.47,-257.92C351.82,-248.4 362.05,-235.72 367,-222 372.43,-206.95 374.17,-200.3 367,-186 359.35,-170.74 344.98,-158.75 331.17,-150.06"/></g><!-- product --><g id="node9" class="node"><title>product</title><polygon fill="#999999" stroke="blue" points="476,-222 400,-222 396,-218 396,-186 472,-186 476,-190 476,-222"/><polyline fill="none" stroke="blue" points="472,-218 396,-218 "/><polyline fill="none" stroke="blue" points="472,-218 472,-186 "/><polyline fill="none" stroke="blue" points="472,-218 476,-222 "/><text text-anchor="middle" x="436" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">PRODUCT</text></g><!-- rest&#45;&#45;product --><g id="edge6" class="edge"><title>rest&#45;&#45;product</title><path fill="none" stroke="blue" stroke-width="2" d="M350.07,-258.23C367.7,-247.31 390.63,-233.11 408.37,-222.12"/></g><!-- stock --><g id="node10" class="node"><title>stock</title><polygon fill="#999999" stroke="blue" points="556,-222 498,-222 494,-218 494,-186 552,-186 556,-190 556,-222"/><polyline fill="none" stroke="blue" points="552,-218 494,-218 "/><polyline fill="none" stroke="blue" points="552,-218 552,-186 "/><polyline fill="none" stroke="blue" points="552,-218 556,-222 "/><text text-anchor="middle" x="525" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">STOCK</text></g><!-- rest&#45;&#45;stock --><g id="edge7" class="edge"><title>rest&#45;&#45;stock</title><path fill="none" stroke="blue" stroke-width="2" d="M350.19,-266.89C382.58,-257.04 438.18,-239.57 485,-222 487.83,-220.94 490.75,-219.8 493.66,-218.62"/></g><!-- report --><g id="node12" class="node"><title>report</title><polygon fill="#999999" stroke="blue" points="357.5,-222 292.5,-222 288.5,-218 288.5,-186 353.5,-186 357.5,-190 357.5,-222"/><polyline fill="none" stroke="blue" points="353.5,-218 288.5,-218 "/><polyline fill="none" stroke="blue" points="353.5,-218 353.5,-186 "/><polyline fill="none" stroke="blue" points="353.5,-218 357.5,-222 "/><text text-anchor="middle" x="323" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">REPORT</text></g><!-- rest&#45;&#45;report --><g id="edge11" class="edge"><title>rest&#45;&#45;report</title><path fill="none" stroke="blue" stroke-width="2" d="M323,-257.7C323,-246.85 323,-232.92 323,-222.1"/></g><!-- client --><g id="node13" class="node"><title>client</title><polygon fill="#999999" stroke="blue" points="129.5,-150 68.5,-150 64.5,-146 64.5,-114 125.5,-114 129.5,-118 129.5,-150"/><polyline fill="none" stroke="blue" points="125.5,-146 64.5,-146 "/><polyline fill="none" stroke="blue" points="125.5,-146 125.5,-114 "/><polyline fill="none" stroke="blue" points="125.5,-146 129.5,-150 "/><text text-anchor="middle" x="97" y="-128.3" font-family="Times,serif" font-size="14.00" fill="blue">CLIENT</text></g><!-- rest&#45;&#45;client --><g id="edge8" class="edge"><title>rest&#45;&#45;client</title><path fill="none" stroke="blue" stroke-width="2" d="M295.88,-272.18C243.6,-266.15 131.79,-250.21 107,-222 89.65,-202.26 90.85,-169.8 93.67,-150.01"/></g><!-- audit --><g id="node14" class="node"><title>audit</title><polygon fill="#999999" stroke="blue" points="632,-222 578,-222 574,-218 574,-186 628,-186 632,-190 632,-222"/><polyline fill="none" stroke="blue" points="628,-218 574,-218 "/><polyline fill="none" stroke="blue" points="628,-218 628,-186 "/><polyline fill="none" stroke="blue" points="628,-218 632,-222 "/><text text-anchor="middle" x="603" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">AUDIT</text></g><!-- rest&#45;&#45;audit --><g id="edge9" class="edge"><title>rest&#45;&#45;audit</title><path fill="none" stroke="blue" stroke-width="2" d="M350.34,-270.89C395.7,-263.66 489.02,-247.02 565,-222 567.88,-221.05 570.84,-219.96 573.78,-218.79"/></g><!-- comm --><g id="node15" class="node"><title>comm</title><polygon fill="#999999" stroke="blue" points="77.5,-222 20.5,-222 16.5,-218 16.5,-186 73.5,-186 77.5,-190 77.5,-222"/><polyline fill="none" stroke="blue" points="73.5,-218 16.5,-218 "/><polyline fill="none" stroke="blue" points="73.5,-218 73.5,-186 "/><polyline fill="none" stroke="blue" points="73.5,-218 77.5,-222 "/><text text-anchor="middle" x="47" y="-200.3" font-family="Times,serif" font-size="14.00" fill="blue">COMM</text></g><!-- rest&#45;&#45;comm --><g id="edge10" class="edge"><title>rest&#45;&#45;comm</title><path fill="none" stroke="blue" stroke-width="2" d="M295.66,-269.98C252.1,-261.69 164.47,-243.89 92,-222 87.36,-220.6 82.52,-218.96 77.8,-217.26"/></g><!-- tenancy&#45;&#45;db1 --><g id="edge12" class="edge"><title>tenancy&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M270.21,-188.88C311.69,-174.53 370.1,-153.87 374,-150 388.2,-135.91 397.77,-116.69 404.19,-98"/></g><!-- user&#45;&#45;db1 --><g id="edge13" class="edge"><title>user&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M170.26,-189.36C173.17,-188.13 176.12,-186.99 179,-186 248.78,-162.11 279.02,-189.99 341,-150 361.54,-136.75 358.61,-124.99 374,-106 376.98,-102.33 378.26,-101.85 381,-98"/></g><!-- user&#45;&#45;session --><g id="edge1" class="edge"><title>user&#45;&#45;session</title><path fill="none" stroke="blue" stroke-width="2" d="M170.11,-190.14C173.1,-188.74 176.11,-187.33 179,-186 206.22,-173.41 237.14,-159.42 260.35,-148.97"/></g><!-- session&#45;&#45;db1 --><g id="edge14" class="edge"><title>session&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M327.24,-113.96C333.35,-111.03 339.79,-108.23 346,-106 361.02,-100.62 368.18,-107.51 381,-98"/></g><!-- product&#45;&#45;db1 --><g id="edge15" class="edge"><title>product&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M434.07,-185.97C431.75,-165.38 427.7,-129.58 424.12,-98"/></g><!-- stock&#45;&#45;db1 --><g id="edge16" class="edge"><title>stock&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M512.58,-185.83C497.87,-165.27 472.85,-129.65 453,-98"/></g><!-- runonce --><g id="node11" class="node"><title>runonce</title><polygon fill="#999999" stroke="lightblue" points="631.5,-294 550.5,-294 550.5,-258 631.5,-258 631.5,-294"/><text text-anchor="middle" x="591" y="-272.3" font-family="Times,serif" font-size="14.00" fill="blue">RUNONCE</text></g><!-- runonce&#45;&#45;db1 --><g id="edge17" class="edge"><title>runonce&#45;&#45;db1</title><path fill="none" stroke="magenta" stroke-width="2" d="M613.6,-257.96C624.06,-248.63 635.4,-236.11 641,-222 646.91,-207.13 648.29,-200.24 641,-186 613.29,-131.87 586.83,-127.65 530,-106 497.85,-93.75 481.83,-116.79 453,-98"/></g><!-- client&#45;&#45;db1 --><g id="edge18" class="edge"><title>client&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M129.53,-124.8C160.81,-119.07 209.47,-110.74 252,-106 266.27,-104.41 368.81,-105.59 381,-98"/></g><!-- audit&#45;&#45;db1 --><g id="edge19" class="edge"><title>audit&#45;&#45;db1</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M587.31,-185.86C566.34,-164 527.04,-126.59 486,-106 472.51,-99.23 465.06,-107.07 453,-98"/></g><!-- comm&#45;&#45;client --><g id="edge2" class="edge"><title>comm&#45;&#45;client</title><path fill="none" stroke="blue" stroke-width="2" d="M59.36,-185.7C67.11,-174.85 77.06,-160.92 84.78,-150.1"/></g></g></svg></div>
</center>
<div><!-- Generated by graphviz version 2.50.0 (0)
 --><!-- Pages: 1 --><svg width="278pt" height="147pt"
 viewBox="0.00 0.00 278.00 147.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 143)"><g id="clust1" class="cluster"><title>cluster_legenda</title><polygon fill="white" stroke="black" points="8,-8 8,-131 262,-131 262,-8 8,-8"/><text text-anchor="middle" x="135" y="-115.8" font-family="Times,serif" font-size="14.00">Legenda: Tipos de Conexão</text></g><!-- key --><g id="node1" class="node"><title>key</title><polygon fill="transparent" stroke="transparent" points="182,-100 16,-100 16,-16 182,-16 182,-100"/><text text-anchor="start" x="131" y="-82.8" font-family="Times,serif" font-size="14.00">gRPC &#160;</text><text text-anchor="start" x="26" y="-63.8" font-family="Times,serif" font-size="14.00">Banco de Dados via Pool &#160;</text><text text-anchor="start" x="33" y="-44.8" font-family="Times,serif" font-size="14.00">Banco de Dados Avulsa &#160;</text><text text-anchor="start" x="70" y="-25.8" font-family="Times,serif" font-size="14.00">HTTP via REST &#160;</text></g><!-- key2 --><g id="node2" class="node"><title>key2</title><polygon fill="transparent" stroke="transparent" points="254,-100 200,-100 200,-16 254,-16 254,-100"/><text text-anchor="start" x="225" y="-82.8" font-family="Times,serif" font-size="14.00"></text><text text-anchor="start" x="225" y="-63.8" font-family="Times,serif" font-size="14.00"></text><text text-anchor="start" x="225" y="-44.8" font-family="Times,serif" font-size="14.00"></text><text text-anchor="start" x="225" y="-25.8" font-family="Times,serif" font-size="14.00"></text></g><!-- key&#45;&#45;key2 --><g id="edge1" class="edge"><title>key:e&#45;&#45;key2:w</title><path fill="none" stroke="blue" stroke-width="2" d="M175,-87C195.89,-87 201.11,-87 222,-87"/></g><!-- key&#45;&#45;key2 --><g id="edge2" class="edge"><title>key:e&#45;&#45;key2:w</title><path fill="none" stroke="darkmagenta" stroke-width="2" d="M175,-68C195.89,-68 201.11,-68 222,-68"/></g><!-- key&#45;&#45;key2 --><g id="edge3" class="edge"><title>key:e&#45;&#45;key2:w</title><path fill="none" stroke="magenta" stroke-width="2" d="M175,-48C195.89,-48 201.11,-48 222,-48"/></g><!-- key&#45;&#45;key2 --><g id="edge4" class="edge"><title>key:e&#45;&#45;key2:w</title><path fill="none" stroke="green" stroke-width="2" d="M175,-29C195.89,-29 201.11,-29 222,-29"/></g></g></svg></div>
<h2 id="bibliotecas"><a class="header" href="#bibliotecas">Bibliotecas</a></h2>
<p>As bibliotecas planejadas para o sistema são:</p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-rpc</code>: Implementação de protocolos gRPC e de mensagens destes
protocolo. Deve ser importado em todos os módulos, sendo essencial para
a criação de clientes e servidores gRPC. Os modelos de comunicação
implementados para si devem ser também convertidos para e
a partir dos DTOs do módulo de dados.</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-data</code>: Implementação de utilitários de comunicação com banco de
dados (PostgreSQL) e objetos de transferência de dados (DTOs). Deve ser
importado em todos os módulos, exceto na comunicação REST. Os DTOs também
devem implementar traits e utilitários para conversão das mensagens
implementadas em <code>minerva-rpc</code> para os DTOs desta biblioteca.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-cache</code>: Implementação de utilitários de comunicação com
cache, message brokers e armazenamento temporário <em>in-memory</em> (Redis).
Deve ser importado principalmente no módulo de sessão.</li>
</ul>
<h2 id="módulos"><a class="header" href="#módulos">Módulos</a></h2>
<p>Os módulos planejados para o sistema são:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<code>minerva-tenancy</code>: Servidor gRPC para CRUD de inquilinos. Deve ser
capaz de gerenciar inquilinos, mas um inquilino não pode ser deletado
através desse serviço, apenas desativado. Apenas administradores do sistema
podem ter acesso.</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-user</code>: Servidor gRPC para CRUD de usuários. Deve ser capaz de
manipular as regras de negócios relacionadas a clientes.</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-session</code>: Servidor gRPC para gerência de sessão de usuário.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-product</code>: Servidor gRPC para CRUD de produtos. Deve ser capaz
de manipular as regras de negócios relacionadas a produtos, mas que não
envolvam controle de estoque.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-stock</code>: Servidor gRPC para CRUD de estoque de produtos. Deve
ser capaz de manipular as regras de negócios relacionadas a estoque, mas
que não envolvam manipulação de produtos.</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-rest</code>: Servidor REST para comunicação com os demais módulos
executáveis. Possui rotas que apontam para serviços específicos, e é por
definição um cliente gRPC de todos os servidores gRPC.</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>minerva-runonce</code>: Serviço <strong>avulso</strong> para configuração do ambiente, de
forma assíncrona. Responsável pela execução de migrações do banco de dados
e outras operações de configuração inicial.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-report</code>: Servidor gRPC para geração de relatórios. Deve receber
dados com formatação esperada de um relatório, e então deverá gerar um
arquivo PDF e retorná-lo inteiramente como resposta.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-client</code>: Servidor gRPC para CRUD de clientes. Deve ser capaz
de manipular as regras de negócios relacionadas a clientes.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-audit</code>: Servidor gRPC para gerenciamento de logs de auditoria.
Possibilita a consulta aos logs de auditoria do sistema.</li>
<li><input disabled="" type="checkbox"/>
<code>minerva-comm</code>: Servidor gRPC para comunicação externa com clientes
via mensagens instantâneas.</li>
</ul>
<h2 id="portas"><a class="header" href="#portas">Portas</a></h2>
<p>Os serviços, independente de serem gRPC ou REST, devem ser executados em
certas portas padrão para evitarem conflitos durante o tempo de depuração.
Cada porta deve também ser configurável através de variáveis de ambiente.</p>
<p>A tabela a seguir discrimina as variáveis de ambiente e as portas padrão
de acordo com o serviço em questão.</p>
<table><thead><tr><th>Serviço</th><th>Variável</th><th>Valor</th></tr></thead><tbody>
<tr><td>REST</td><td><code>ROCKET_PORT</code></td><td>9000</td></tr>
<tr><td>USER</td><td><code>USER_SERVICE_PORT</code></td><td>9010</td></tr>
<tr><td>SESSION</td><td><code>SESSION_SERVICE_PORT</code></td><td>9011</td></tr>
<tr><td>PRODUCT</td><td><code>PRODUCT_SERVICE_PORT</code></td><td>9012</td></tr>
<tr><td>STOCK</td><td><code>STOCK_SERVICE_PORT</code></td><td>9013</td></tr>
<tr><td>REPORT</td><td><code>REPORT_SERVICE_PORT</code></td><td>9014</td></tr>
<tr><td>TENANCY</td><td><code>TENANCY_SERVICE_PORT</code></td><td>9015</td></tr>
<tr><td>CLIENT</td><td><code>CLIENT_SERVICE_PORT</code></td><td>9016</td></tr>
<tr><td>AUDIT</td><td><code>AUDIT_SERVICE_PORT</code></td><td>9017</td></tr>
<tr><td>COMM</td><td><code>COMM_SERVICE_PORT</code></td><td>9018</td></tr>
</tbody></table>
<p>No caso do serviço REST, verifique o arquivo <code>Rocket.toml</code> para avaliar
a configuração em desenvolvimento e em produção do mesmo.</p>
<h2 id="gateways"><a class="header" href="#gateways">Gateways</a></h2>
<p>Os serviços também podem operar em máquinas diferentes, dependendo de sua
rota.</p>
<p>Normalmente, quando todos os serviços são executados manualmente na mesma
máquina, operamos com uma rota <code>localhost</code>. Nesse caso, a variável de
ambiente de cada serviço é definida como esse valor.</p>
<p>Todavia, num ambiente de orquestração de contêineres (como Docker Compose
ou Kubernetes), cada serviço estará operando de forma separada, e poderá
comunicar-se com os outros serviços por intermédio de uma rede interna
ao qual apenas os serviços têm acesso de forma explícita. Assim, as
variáveis de ambiente que determinam o nome do servidor devem ser definidas
manualmente, de acordo com a forma como o deploy de cada serviço foi
realizado.</p>
<p>A seguir, temos uma tabela relacionando variáveis de ambiente com seus
devidos valores, que serão resolvidos através do DNS da rede interna criada
pelo orquestrador de contêineres.</p>
<p>No caso do serviço REST, verifique o arquivo <code>Rocket.toml</code> para avaliar
a configuração em desenvolvimento e em produção do mesmo.</p>
<table><thead><tr><th>Serviço</th><th>Variável</th><th>Valor em Produção</th></tr></thead><tbody>
<tr><td>USER</td><td><code>USER_SERVICE_SERVER</code></td><td><code>user</code></td></tr>
<tr><td>Banco de Dados Relacional</td><td><code>DATABASE_SERVICE_SERVER</code></td><td><code>postgresql</code></td></tr>
<tr><td>Banco de Dados Não-Relacional</td><td><code>MONGO_SERVICE_SERVER</code></td><td><code>mongodb</code></td></tr>
<tr><td>REST</td><td>nenhuma</td><td><code>rest</code></td></tr>
<tr><td>RUNONCE</td><td>nenhuma</td><td><code>runonce</code></td></tr>
<tr><td>SESSION</td><td><code>SESSION_SERVICE_SERVER</code></td><td><code>session</code></td></tr>
</tbody></table>
<div style="break-before: page; page-break-before: always;"></div><h1 id="documentação-do-projeto"><a class="header" href="#documentação-do-projeto">Documentação do Projeto</a></h1>
<p>Esta seção contém links para a documentação das partes pertinentes ao código
do Minerva System.</p>
<p>Por padrão, a documentação é escrita em Inglês, e pode ser muito pertinente
durante a implementação de novas partes do sistema.</p>
<p>Não se esqueça de consultar estes documentos com frequência.</p>
<h2 id="api"><a class="header" href="#api">API</a></h2>
<ul>
<li><a href="https://documenter.getpostman.com/view/17061755/Uyxoi4MU">Documentação da API</a><br />
Documentação da API REST (Postman, em Inglês).</li>
</ul>
<h2 id="serviços-externos"><a class="header" href="#serviços-externos">Serviços externos</a></h2>
<ul>
<li><a href="./doc/minerva_frontend/index.html">FRONTEND</a><br />
<em>Front-End</em> do Minerva System.</li>
<li><a href="./doc/minerva_rest/index.html">REST</a><br />
<em>Gateway</em> REST para acesso aos demais serviços.</li>
</ul>
<h2 id="microsserviços"><a class="header" href="#microsserviços">Microsserviços</a></h2>
<ul>
<li><a href="./doc/minerva_runonce/index.html">RUNONCE</a><br />
Utilitário de configuração inicial do sistema durante um deploy.</li>
<li><a href="./doc/minerva_session/index.html">SESSION</a><br />
Serviço de gerenciamento de sessão de usuário.</li>
<li><a href="./doc/minerva_user/index.html">USER</a><br />
Serviço de gerenciamento de usuários.</li>
<li>PRODUCT <em>(não implementado)</em><br />
Serviço de gerenciamento de produtos.</li>
<li>REPORT <em>(não implementado)</em><br />
Serviço de gerenciamento e emissão de relatórios.</li>
<li>STOCK <em>(não implementado)</em><br />
Serviço de gerenciamento de estoques de produtos.</li>
<li>CLIENT <em>(não implementado)</em><br />
Serviço de gerenciamento de clientes.</li>
<li>AUDIT <em>(não implementado)</em><br />
Serviço de gerenciamento de <em>logs</em> de auditoria.</li>
<li>TENANCY <em>(não implementado)</em><br />
Serviço de gerenciamento de inquilinos.</li>
<li>COMM <em>(não implementado)</em><br />
Serviço de gerenciamento de comunicações via mensagem instantânea.</li>
</ul>
<h2 id="bibliotecas-1"><a class="header" href="#bibliotecas-1">Bibliotecas</a></h2>
<ul>
<li><a href="./doc/minerva_data/index.html">DATA</a><br />
Biblioteca de manipulação de DTOs e conversões de dados.</li>
<li><a href="./doc/minerva_rpc/index.html">RPC</a><br />
Biblioteca de implementação de Protocol Buffers, mensagens gRPC e afins.</li>
<li><a href="./doc/minerva_cache/index.html">CACHE</a><br />
Biblioteca para uso e acesso ao cache via serviço Redis.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diagramas-de-casos-de-uso"><a class="header" href="#diagramas-de-casos-de-uso">Diagramas de Casos de Uso</a></h1>
<p>Os diagramas a seguir representam casos de uso para o sistema. Esses diagramas
não têm a pretensão de serem completos, mas sim de ilustrar funcionalidades
esperadas para o sistema, de forma visual.</p>
<p>Os casos de uso foram subdivididos em domínios, que poderão ilustrar os
microsserviços envolvidos.</p>
<h2 id="sessão"><a class="header" href="#sessão">Sessão</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/b87e39b1206ba08e74bf27671e994903347e3022.svg" alt="" /></p>
</center>
<h2 id="usuários"><a class="header" href="#usuários">Usuários</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/11b49a40ed99cebd41bb3995a2ce327b0b92bcfd.svg" alt="" /></p>
</center>
<h2 id="inquilinos"><a class="header" href="#inquilinos">Inquilinos</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/efc707391e2f738978112443ce8c9346e824d4e9.svg" alt="" /></p>
</center>
<h2 id="auditoria"><a class="header" href="#auditoria">Auditoria</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/9afec32f78ded26d4a1f45055f420f169d596899.svg" alt="" /></p>
</center>
<h2 id="relatórios"><a class="header" href="#relatórios">Relatórios</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/711c59ff7a043d671a321a92f5360d366a2d6b78.svg" alt="" /></p>
</center>
<h2 id="produtos"><a class="header" href="#produtos">Produtos</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/92b572e1e92e412ca7e779b0cbeb1c6d16c9ba79.svg" alt="" /></p>
</center>
<h2 id="estoque"><a class="header" href="#estoque">Estoque</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/a43e8db0ff12b4048086ace3441f356e02ad0a90.svg" alt="" /></p>
</center>
<h2 id="clientes"><a class="header" href="#clientes">Clientes</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/708e143d29530b33d215eb8d675bce449b4e5066.svg" alt="" /></p>
</center>
<h2 id="comunicação-instantânea"><a class="header" href="#comunicação-instantânea">Comunicação Instantânea</a></h2>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/e8b4f6f3ad3ae5fbd4083e97c12050b69cad9eea.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diagramas-de-sequência"><a class="header" href="#diagramas-de-sequência">Diagramas de sequência</a></h1>
<p>As seções a seguir enumeram diagramas de sequência. Esses diagramas representam
visualmente informações a respeito das operações realizadas para cada ação que
a eles der título, e são de grande ajuda no momento do projeto do sistema.</p>
<p>Os diagramas a seguir foram gerados automaticamente através de PlantUML.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diagramas-de-sequência-sessão"><a class="header" href="#diagramas-de-sequência-sessão">Diagramas de Sequência: Sessão</a></h1>
<p>Os diagramas a seguir dizem respeito ao fluxo de gerenciamento da sessão de um
usuário do sistema.</p>
<p>A gerência da sessão assume que os dados do usuário possam ou não serem
encontrados no banco de dados. Dito isso, não é incumbência da sessão realizar
operações CRUD como usuários, e sim com a entidade da sessão em si.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="login-do-usuário"><a class="header" href="#login-do-usuário">Login do usuário</a></h1>
<p>Após o <em>login</em> ser realizado, as sessões no Redis e no MongoDB obedecem um tempo
de vida limitado.</p>
<ul>
<li><strong>Redis</strong>: Algumas horas.</li>
<li><strong>MongoDB</strong>: Uma semana.</li>
</ul>
<p>Isso é gerenciado pelos próprios serviços. O MongoDB fará isso através do tempo
de vida da coleção para aquele banco, enquanto o Redis fará isso através do
tempo de vida da informação quando a mesma foi colocada em cache.</p>
<p><strong>TODO:</strong> Seria mais adequado fazer com que <code>SESSION</code> requeira a <code>USER</code> os
dados dos usuários, ao invés de recorrer ao banco?</p>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/63458478c32d8ed0a4f0f23445e03b499e30425d.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logoff-do-usuário"><a class="header" href="#logoff-do-usuário">Logoff do usuário</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/c402aeccb3fe3fc3e14504ca2f28fedab4b68c8f.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diagramas-de-sequência-usuários"><a class="header" href="#diagramas-de-sequência-usuários">Diagramas de Sequência: Usuários</a></h1>
<p>Os diagramas a seguir dizem respeito ao fluxo de gerenciamento de usuários no
sistema.</p>
<p>A gerência de usuários não diz respeito à sessão em si.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cadastro-de-usuários"><a class="header" href="#cadastro-de-usuários">Cadastro de usuários</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/5f55690e3503d66808f0db9a30a4c270c15b5514.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="listagem-de-usuários"><a class="header" href="#listagem-de-usuários">Listagem de usuários</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/fb4c7675a8889cd1691a916d3d32270d802eed2c.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="consultar-usuário"><a class="header" href="#consultar-usuário">Consultar usuário</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/187126b200584370ac865b5a8943df58615ea8e0.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="alteração-do-cadastro-de-usuários"><a class="header" href="#alteração-do-cadastro-de-usuários">Alteração do cadastro de usuários</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/b4371f532464997c6570b0d00a457609603c94be.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="remoção-de-usuários"><a class="header" href="#remoção-de-usuários">Remoção de usuários</a></h1>
<center>
<p><img src="diagramas/../mdbook-plantuml-img/4952d165285d7398dd046430df9632fec61a76f7.svg" alt="" /></p>
</center>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-tenancy"><a class="header" href="#multi-tenancy">Multi-Tenancy</a></h1>
<p>O Sistema Minerva é um sistema <em>multi-tenant</em>. Isso significa que é
capaz de gerenciar bancos de dados diferentes dependendo do <em>tenant</em>
(cliente do serviço) atual. No Sistema Minerva, isso é gerenciado de
acordo com a forma como as requisições são recebidas.</p>
<p>Atualmente, o <em>multi-tenancy</em> é gerenciado de forma estática, através
de um arquivo de configuração, mas em breve será gerenciado através
do microsserviço <code>TENANCY</code>.</p>
<h2 id="configuração"><a class="header" href="#configuração">Configuração</a></h2>
<p>Os tenants devem ser gerenciados através do arquivo <code>tenancy.toml</code>.</p>
<p>A seguir, um exemplo do conteúdo em potencial deste arquivo.</p>
<pre><code class="language-toml">[[tenants]]
name = &quot;Minerva System&quot;
database = &quot;minerva&quot;
connections = 5

[[tenants]]
name = &quot;Test Database&quot;
database = &quot;teste&quot;
connections = 5

[[tenants]]
name = &quot;Comercial Fulano S/A&quot;
database = &quot;comercial-fulano&quot;
connections = 5
</code></pre>
<h2 id="criação-dos-bancos-de-dados"><a class="header" href="#criação-dos-bancos-de-dados">Criação dos bancos de dados</a></h2>
<p>O serviço <code>RUNONCE</code> deverá executar a criação dos bancos de dados, caso
não seja possível conectar-se aos mesmos. Isso deve ser feito sobretudo
através da leitura do arquivo <code>tenancy.toml</code>, encontrado na pasta de
execução do projeto.</p>
<p>Caso um novo tenant seja adicionado ao sistema, o serviço <code>RUNONCE</code>
deverá ser forçadamente executado para que o sistema fique apto a
utilizar o banco de dados para aquele tenant.</p>
<p>O sistema <code>RUNONCE</code> deverá, para cada tenant listado em <code>tenancy.toml</code>:</p>
<ol>
<li>Tentar conectar-se aos bancos em questão. Se isso não for possível,
deverá criá-los;</li>
<li>Executar as migrations (no BD relacional) para aquele <em>tenant</em>;</li>
<li>Criar as coleções e índices (no BD não-relacional) para aquele <em>tenant</em>;</li>
<li>Criar o usuário <code>admin</code> (no BD relacional) para aquele <em>tenant</em>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="banco-de-dados-relacional"><a class="header" href="#banco-de-dados-relacional">Banco de Dados Relacional</a></h1>
<p>As próximas seções dizem respeito a partes relacionadas à estrutura do banco
de dados relacional (PostgreSQL) e a como modificá-la.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="executando-migrations"><a class="header" href="#executando-migrations">Executando migrations</a></h1>
<p>As migrations são uma parte vital do Sistema Minerva, não apenas porque
definem as tabelas do banco de um <em>tenant</em>, mas porque também definem os
<em>schemas</em> para a programação dos módulos.</p>
<h2 id="pré-requisitos"><a class="header" href="#pré-requisitos">Pré-requisitos</a></h2>
<ul>
<li><a href="https://rustup.rs">Rust</a> (compilador <code>rustc</code> e gerenciador de
pacotes <code>cargo</code>, versão 1.60.0 ou superior);</li>
<li><a href="https://diesel.rs">Diesel</a> (versão 1.4.1 ou superior, com suporte
a PostgreSQL);</li>
<li><code>diesel_cli</code> com suporte a PostgreSQL;</li>
<li>Docker versão 20.10 ou superior.</li>
</ul>
<p>Para instalar o <code>diesel_cli</code> apenas com suporte a PostgreSQL, use o
seguinte comando:</p>
<pre><code class="language-bash">cargo install diesel_cli --no-default-feature --features postgres
</code></pre>
<h2 id="considerações-importantes"><a class="header" href="#considerações-importantes">Considerações importantes</a></h2>
<p><strong>Toda e qualquer migration deve ser criada no diretório do módulo
<code>minerva-runonce</code></strong>, especificamente porque este diretório possui também
as configurações de acesso e de geração de <em>schema</em> em
<code>minerva-data/src/schema.rs</code>.</p>
<p>Além disso, <strong>sempre execute todos os comandos abaixo no diretório do módulo
<code>minerva-runonce</code></strong>.</p>
<h2 id="configuração-inicial"><a class="header" href="#configuração-inicial">Configuração inicial</a></h2>
<p>Para começar, crie um contêiner Docker para cada um dos bancos de dados:</p>
<pre><code class="language-bash">./make_postgres_db.sh
./make_mongo_db.sh
./make_redis_db.sh
</code></pre>
<p>Isso criará contêineres executando PostgreSQL 14, MongoDB 5 e Redis 7.</p>
<p>Após a criação dos contêineres, o processo de preparação dos bancos de dados
pode ser um pouco demorado. Acompanhe este processo observando os logs:</p>
<pre><code class="language-bash"># Banco relacional
docker logs -f minerva-postgres

# Banco não-relacional
docker logs -f minerva-mongo

# Cache
docker logs -f minerva-redis
</code></pre>
<p>Em seguida, execute a operação inicial de criação de um banco de dados.
Para tanto, vamos criar um banco chamado <code>minerva</code> e executar todas as
migrations nele, logo de cara:</p>
<pre><code class="language-bash">diesel setup --database-url=&quot;postgres://postgres:postgres@localhost/minerva&quot;
</code></pre>
<h2 id="criando-uma-migration"><a class="header" href="#criando-uma-migration">Criando uma migration</a></h2>
<p>Para criar uma <em>migration</em>, use um comando similar ao seguinte:</p>
<pre><code class="language-bash">diesel migration generate &lt;nome_da_migration&gt;
</code></pre>
<p>Substitua <code>&lt;nome_da_migration&gt;</code> por um nome que faça sentido.
Isso gerará uma nova <em>migration</em> no diretório <code>migrations</code>,
que possuirá os arquivos <code>up.sql</code> e <code>down.sql</code>. Edite-os de acordo
com o necessário.</p>
<h2 id="executando-migrations-1"><a class="header" href="#executando-migrations-1">Executando migrations</a></h2>
<p>Para executar todas as <em>migrations</em> pendentes, execute o comando:</p>
<pre><code class="language-bash">diesel migration run --database-url=&quot;postgres://postgres:postgres@localhost/minerva&quot;
</code></pre>
<p>Isso também poderá reconstruir o arquivo <code>minerva-data/src/schema.rs</code>, a depender
de mudanças no <em>schema</em>.</p>
<p>Para testar a última migration executada:</p>
<pre><code class="language-bash">diesel migration redo --database-url=&quot;postgres://postgres:postgres@localhost/minerva&quot;
</code></pre>
<h2 id="removendo-banco-de-dados-de-teste"><a class="header" href="#removendo-banco-de-dados-de-teste">Removendo banco de dados de teste</a></h2>
<p>Para remover os bancos de dados de teste criados no Docker, use os comandos a
seguir.</p>
<p>Estes comandos servem para, respectivamente, parar a execução dos contêineres e
então excluí-los.</p>
<pre><code class="language-bash">docker stop minerva-postgres minerva-mongo minerva-redis
docker rm minerva-postgres minerva-mongo minerva-redis
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="banco-de-dados-não-relacional"><a class="header" href="#banco-de-dados-não-relacional">Banco de Dados Não-Relacional</a></h1>
<p>As próximas seções dizem respeito a partes relacionadas à estrutura do banco
de dados não-relacional (MongoDB) e a seu uso.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coleções"><a class="header" href="#coleções">Coleções</a></h1>
<p>Assim como no caso do banco de dados relacional, o banco de dados não-relacional
(criado através do MongoDB) também trabalha com um sistema <em>multi-tenant</em>, sendo
portanto representável como um banco de dados para cada cliente.</p>
<p>Ainda assim, para cada cliente, algumas coleções são essenciais de serem criadas
e configuradas até mesmo antes do primeiro acesso.</p>
<h2 id="coleção-session"><a class="header" href="#coleção-session">Coleção <code>session</code></a></h2>
<p>A coleção <code>session</code> armazena documentos contendo dados de sessão de um usuário.
A responsabilidade de armazenar dados dos usuários é do banco de dados relacional,
assim como a responsabilidade de autenticá-los é do serviço <code>SESSION</code>. Esta coleção,
todavia, armazena os dados de autenticação após a realização de um login válido.</p>
<p>Cada documento nesta coleção possui um tempo de expiração de uma semana, o que
alinha-se com o tempo máximo de uma sessão do usuário ser, igualmente, uma semana.
A gerência desse tempo de expiração se dá através de um campo <code>creationDate</code> no
documento, que armazena um <em>timestamp</em> indicando a data de início daquela sessão.
Caso o documento não possua esse campo, o MongoDB, por padrão, acaba não expirando-o.</p>
<p>A responsabilidade da definição e criação adequada do <code>creationDate</code> é do serviço
<code>SESSION</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compilação"><a class="header" href="#compilação">Compilação</a></h1>
<p>Este capítulo fala a respeito das formas de compilação do sistema.</p>
<p>Para compilar e executar a aplicação, vamos utilizar recursos da
máquina (em caso de situações envolvendo desenvolvimento) ou teste
de aplicação usando Docker.</p>
<p>A geração de imagens Docker é particularmente importante para a
realização de testes e deploy posteriores, o que será abordado
no próximo capítulo.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compilando-e-executando-com-recursos-da-máquina"><a class="header" href="#compilando-e-executando-com-recursos-da-máquina">Compilando e executando com recursos da máquina</a></h1>
<p>Você pode compilar os módulos do sistema individualmente e executá-los
usando o próprio ambiente Rust.</p>
<h2 id="introdução-1"><a class="header" href="#introdução-1">Introdução</a></h2>
<p>Este artigo trata da situação mais comum durante o desenvolvimento das
partes do sistema, que envolve utilizá-las individualmente em um
ambiente de desenvolvimento.</p>
<p>O <em>deploy</em> usando Docker Compose e Kubernetes, enquanto possível em
ambiente de homologação e de testes manuais, utiliza muitos recursos
da máquina, e não é o ideal de ser utilizado enquanto o programador
estiver debugando a aplicação. Além disso, pela própria forma como
o sistema foi planejado, é possível executar porções individuais do
sistema em que haja interdependência entre elas.</p>
<h2 id="objetivo"><a class="header" href="#objetivo">Objetivo</a></h2>
<p>Compilar todos os módulos ou módulos individuais é muito importante do
ponto de vista do desenvolvimento. Neste artigo, tratamos de como isso
pode ser feito na máquina local de um desenvolvedor.</p>
<h2 id="dependências"><a class="header" href="#dependências">Dependências</a></h2>
<p>Você precisará de:</p>
<ul>
<li><a href="https://rustup.rs">Rust</a> (compilador <code>rustc</code> e gerenciador de
pacotes <code>cargo</code>, versão 1.60.0 ou superior);</li>
<li><a href="https://diesel.rs">Diesel</a> (versão 1.4.1 ou superior, com suporte
a PostgreSQL);</li>
<li><a href="https://flutter.dev">Flutter</a> (versão 3.0.0 ou superior, canal
<code>stable</code>. Apenas necessário o <em>target</em> de compilação para <code>web</code>);</li>
<li>Dart (versão 2.17.0 ou superior, canal <code>stable</code>);</li>
<li>Docker (versão 2.10 ou superior).</li>
</ul>
<p>O compilador Rust e o Docker são essenciais para compilar os módulos
individuais do <em>back-end</em> do projeto, enquanto o Flutter é importante
para a confecção do <em>front-end</em> da aplicação. Sendo assim, as
dependências podem ser instaladas de acordo com o bom-senso do
desenvolvedor.</p>
<p>O Diesel pode ser instalado através do gerenciador de pacotes <code>cargo</code>,
e sua instalação pode ser consultada em seu site, linkado acima. Além
disso, a linguagem Dart será instalada através do Flutter, de acordo
com as instruções que podem ser encontradas no site do mesmo.</p>
<h2 id="estrutura-do-projeto"><a class="header" href="#estrutura-do-projeto">Estrutura do projeto</a></h2>
<p>O repositório do projeto é um <em>monorepo</em>, isto é, engloba todas as
partes do sistema inteiro. Por isso, as partes relacionadas a <em>back-end</em>
estão dispostas em um <em>Workspace</em>, configurável através das próprias
ferramentas do <code>cargo</code> e da linguagem Rust, enquanto o <em>front-end</em>
encontra-se unicamente no diretório <code>minerva_frontend</code>, e não faz
parte do <em>Workspace</em> em si.</p>
<h2 id="preparação-do-ambiente"><a class="header" href="#preparação-do-ambiente">Preparação do ambiente</a></h2>
<p>A primeira parte a ser executada deverá ser a preparação do ambiente.
Isso inclui a preparação de quaisquer serviços ou bancos de dados
externos que possam ser importantes para a execução da aplicação.</p>
<p>No Sistema Minerva, o serviço <code>RUNONCE</code> é responsável por executar
essas operações, sendo também o serviço que executa <em>migrations</em> no
banco de dados, por exemplo.</p>
<p>Para tanto, precisaremos compilar este módulo específico antes de
qualquer outro. Isso será melhor delineado na seção sobre compilação
do <em>back-end</em>, mas realizaremos uma configuração rápida nesta seção.</p>
<h3 id="criando-o-banco-de-dados"><a class="header" href="#criando-o-banco-de-dados">Criando o banco de dados</a></h3>
<p>Como primeira dependência, recomenda-se criar o banco de dados via
Docker. Também seria possível instalar o PostgreSQL 14 na máquina local,
mas o Docker provê a comodidade necessária para o BD.</p>
<p>O diretório <code>minerva-runonce</code> possui um script que pode ser executado
para a criação do banco de dados. Este script executa o seguinte
comando:</p>
<pre><code class="language-bash">docker run --name minerva-postgres \
       -e POSTGRES_USER=postgres \
       -e POSTGRES_PASSWORD=postgres \
       -p 5432:5432 \
       -d postgres:14-alpine
</code></pre>
<p>Este comando criará um contêiner chamado <code>minerva-postgres</code>, a partir
da imagem Docker do PostgreSQL 14, com usuário e senhas padrão
<code>postgres</code>, e também servindo na porta <code>5432</code> da máquina atual (padrão
do PostgreSQL).</p>
<p>É importante lembrar que <strong>usar o contêiner dessa forma não é muito
seguro para persistência de dados</strong>. Por isso, <strong>pense neste contêiner
como um banco de dados de um ambiente exclusivo de testes.</strong></p>
<p>Caso você precise encerrar o contêiner, use:</p>
<pre><code class="language-bash">docker stop minerva-postgres
</code></pre>
<p>Da mesma forma, não será necessário executar novamente o <code>RUNONCE</code> para
configuração, a não ser que o schema do banco de dados seja alterado.
Nesse caso, cada vez que for necessário reutilizar o banco para testes,
use o comando a seguir para reiniciar o BD:</p>
<pre><code class="language-bash">docker start minerva-postgres
</code></pre>
<h3 id="executando-configuração-inicial-módulo-runonce"><a class="header" href="#executando-configuração-inicial-módulo-runonce">Executando configuração inicial (módulo <code>RUNONCE</code>)</a></h3>
<p>A seguir, execute o módulo <code>RUNONCE</code> para preparar todos os bancos de
dados de <em>tenants</em>, executar as migrations e criar o usuário <code>admin</code>
em cada banco.</p>
<p>Você poderá executar o módulo diretamente a partir da raiz do projeto:</p>
<pre><code class="language-bash">cargo run --bin minerva-runonce
</code></pre>
<p>Caso haja algum problema com o comando anterior (por exemplo, se o
módulo não encontrar o diretório <code>migrations</code>), vá para o diretório do
módulo e execute-o:</p>
<pre><code class="language-bash">cd minerva-runonce
cargo run
</code></pre>
<p>Após a compilação do módulo <code>RUNONCE</code>, o mesmo aguardará o banco de
dados estar pronto para receber as conexões e aplicará as migrations.</p>
<h2 id="compilação-back-end"><a class="header" href="#compilação-back-end">Compilação (<em>Back-end</em>)</a></h2>
<p>Você poderá compilar todos os módulos do projeto de uma só vez, ou
compilar apenas os módulos necessários.</p>
<h3 id="compilando-todos-os-módulos"><a class="header" href="#compilando-todos-os-módulos">Compilando todos os módulos</a></h3>
<p>Para compilar todos os módulos, vá para a raiz do projeto e execute
um comando de compilação para todo o workspace:</p>
<pre><code class="language-bash">cargo build
</code></pre>
<p>De forma similar, você poderá compilar o projeto para produção através
da <em>flag</em> <code>--release</code>:</p>
<pre><code class="language-bash">cargo build --release
</code></pre>
<h3 id="compilando-um-módulo-específico"><a class="header" href="#compilando-um-módulo-específico">Compilando um módulo específico</a></h3>
<p>Existem duas formas de compilar um módulo específico: a partir do
<em>workspace</em> (diretório raiz do repositório) ou a partir do diretório
do módulo específico.</p>
<p>Qualquer módulo pode ser compilado a partir do diretório raiz com um
comando como o mostrado a seguir (substitua <code>&lt;módulo&gt;</code> pelo nome do
diretório do módulo em questão):</p>
<pre><code class="language-bash">cargo build --bin &lt;módulo&gt;
</code></pre>
<p>Isto compilará qualquer módulo que faça parte do <em>workspace</em>, exceto
bibliotecas auxiliares (como <code>minerva-rpc</code>, <code>minerva-data</code> e
<code>minerva-cache</code>) e o <em>front-end</em> (contido em <code>minerva_frontend</code>).</p>
<p>Da mesma forma, você também poderá ir ao diretório do módulo específico
e compilá-lo diretamente; neste caso, a compilação também funcionará
para bibliotecas auxiliares.</p>
<pre><code class="language-bash">cd &lt;módulo&gt;
cargo build
</code></pre>
<p>De forma similar à compilação geral, ambos os comandos também admitem
a <em>flag</em> <code>--release</code> para compilar os módulos para produção.</p>
<h3 id="execução"><a class="header" href="#execução">Execução</a></h3>
<p>É possível executar diretamente um módulo qualquer através do <code>cargo</code>,
o que também implica na sua compilação.</p>
<p>Para executar a partir do diretório do <em>workspace</em> (apenas para
módulos que geram executáveis):</p>
<pre><code class="language-bash">cargo run --bin &lt;módulo&gt;
</code></pre>
<p>Para executar a partir do diretório do módulo em questão:</p>
<pre><code class="language-bash">cd &lt;módulo&gt;
cargo run
</code></pre>
<p>Da mesma forma, é possível compilar e executar os módulos no modo
de produção através da <em>flag</em> <code>--release</code>.</p>
<h3 id="testes"><a class="header" href="#testes">Testes</a></h3>
<p>Para executar testes unitários e integração, basta seguir um processo
similar à execução dos módulos. Testes com binários compilados para
produção podem ser igualmente controlados pela <em>flag</em> <code>--release</code>.</p>
<p>Para executar quaisquer testes, é necessário <strong>garantir</strong> que o
banco de dados esteja acessível e adequadamente configurado.</p>
<pre><code class="language-bash"># Para testar todos os módulos do workspace
cargo test

# Para testar apenas um módulo do workspace
cargo test --bin &lt;módulo&gt;

# Para testar apenas um módulo em seu diretório
cd &lt;módulo&gt;
cargo test
</code></pre>
<h2 id="compilação-front-end"><a class="header" href="#compilação-front-end">Compilação (<em>Front-end</em>)</a></h2>
<p>O front-end é um módulo separado do restante dos módulos, sendo o
sistema que envolve a interface gráfica do Sistema Minerva.</p>
<h3 id="executando-o-projeto-via-console"><a class="header" href="#executando-o-projeto-via-console">Executando o projeto via console</a></h3>
<p>Para executar o projeto via console, basta usar a ferramenta de linha
de comando do Flutter.</p>
<h4 id="preparando-o-flutter"><a class="header" href="#preparando-o-flutter">Preparando o Flutter</a></h4>
<p>Antes de mais nada, garanta que o Flutter esteja configurado para
compilar projetos Web:</p>
<pre><code class="language-bash">flutter config --enable-web
</code></pre>
<p>Além disso, o Google Chrome deverá estar disponível para ser utilizado
no debug. O estado do ambiente Flutter pode ser verificado com o
comando <code>flutter doctor</code>.</p>
<p>Caso haja alguma inconsistência no seu ambiente, veja a seção de
<a href="https://docs.flutter.dev/get-started/web">preparação do Flutter para Web</a>
na documentação oficial.</p>
<h4 id="executando-o-projeto"><a class="header" href="#executando-o-projeto">Executando o projeto</a></h4>
<p>Para executar o projeto, vá até o diretório do módulo de <em>front-end</em>,
baixe as dependências necessárias, e então execute o projeto no Google
Chrome:</p>
<pre><code class="language-bash">cd minerva_frontend
flutter pub get
flutter run -d chrome
</code></pre>
<h3 id="compilando-para-produção"><a class="header" href="#compilando-para-produção">Compilando para produção</a></h3>
<p>Para compilar o projeto para produção, vá até a pasta do módulo e
execute os comandos a seguir. Eles baixarão as dependências faltantes
(caso já não tenham sido baixadas) e gerarão os arquivos estáticos
da aplicação.</p>
<pre><code class="language-bash">cd minerva_frontend
flutter pub get
flutter build web
</code></pre>
<p>Você poderá encontrar a versão compilada da aplicação <em>front-end</em> no
diretório <code>minerva_frontend/build/web</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gerando-imagens-via-docker"><a class="header" href="#gerando-imagens-via-docker">Gerando imagens via Docker</a></h1>
<h2 id="script-para-geração-de-imagens"><a class="header" href="#script-para-geração-de-imagens">Script para geração de imagens</a></h2>
<p>Já existe um script separado para a geração das imagens (com <em>tags</em>
apropriadas). Para gerá-las, vá até a raiz do repositório e execute o comando:</p>
<pre><code class="language-bash">./generate_images.sh
</code></pre>
<p>Esse script foi especialmente feito para um console Bash, e pensado para
execução no Linux. No entanto, caso você esteja no Windows, poderá executá-lo
via Git Bash, MSYS2 ou similar, desde que seja possível utilizar o Docker
através da linha de comando.</p>
<h2 id="gerando-uma-imagem-em-específico"><a class="header" href="#gerando-uma-imagem-em-específico">Gerando uma imagem em específico</a></h2>
<p>Caso seja necessário, você poderá gerar uma imagem em específico de um projeto.</p>
<h3 id="projetos-rust"><a class="header" href="#projetos-rust">Projetos Rust</a></h3>
<p>Para qualquer projeto feito em Rust, poderá executar o seguinte comando a partir
da raiz do repositório:</p>
<pre><code class="language-bash">docker image build -f build/Dockerfile \
	--target minerva_&lt;projeto&gt; \
	-t seu_username/minerva_&lt;projeto&gt;:latest \
	.
</code></pre>
<p>Lembre-se de substituir <code>&lt;projeto&gt;</code> pelo projeto em questão.</p>
<h3 id="front-end"><a class="header" href="#front-end">Front-End</a></h3>
<p>Para gerar o front-end da aplicação, feito com Flutter, teremos que usar um
Dockerfile diferente:</p>
<pre><code class="language-bash">docker image build -f build/Dockerfile.frontend \
	-t seu_username/minerva_frontend:latest \
	.
</code></pre>
<h3 id="criando-uma-tag-para-a-imagem"><a class="header" href="#criando-uma-tag-para-a-imagem">Criando uma tag para a imagem</a></h3>
<p>Todas as imagens são geradas automaticamente com <em>tags</em> de acordo com o projeto
do qual está sendo gerado (arquivos <code>Cargo.toml</code> e <code>pubspec.yaml</code>).</p>
<p>Se você estiver gerando as imagens manualmente, poderá definir uma <em>tag</em> como
no exemplo a seguir:</p>
<pre><code class="language-bash"># Faça algo similar para cada uma das imagens
docker image tag \
	seu_username/minerva_user \
	seu_username/minerva_user:0.2.0
</code></pre>
<h3 id="pgadmin-4"><a class="header" href="#pgadmin-4">PgAdmin 4</a></h3>
<p>A imagem com PgAdmin 4 é customizada com meros arquivos de configuração para
monitoramento do PostgreSQL. Por isso, também usa um Dockerfile diferente.</p>
<p>Veja também que ela é construída no diretório <code>build</code>.</p>
<pre><code class="language-bash">docker image build -f build/Dockerfile.pgadmin \
	-t seu_username/minerva_pgadmin:latest \
	build
</code></pre>
<h2 id="nomes-e-tags-das-imagens-geradas"><a class="header" href="#nomes-e-tags-das-imagens-geradas">Nomes e tags das imagens geradas</a></h2>
<p>As imagens geradas pelos passos anteriores são geradas com nomes
específicos. Esses nomes serão muito úteis do ponto de vista do
envio dessas imagens para o DockerHub e do deploy via Docker
Compose, Docker Swarm e Kubernetes.</p>
<p>As imagens são sempre geradas com a tag <code>latest</code>, mas também
receberão <em>tags</em> de acordo com seus arquivos de projeto (<code>Cargo.toml</code>
e <code>pubspec.yaml</code>).</p>
<p>A seguir, temos uma tabela relacionando os serviços com os nomes e tags
das imagens geradas. Veja que elas se relacionam, inclusive, com a forma
como essas imagens encontram-se no DockerHub (sob o <em>username</em> <code>luksamuk</code>):</p>
<table><thead><tr><th>Serviço</th><th>Nome e tag da imagem</th></tr></thead><tbody>
<tr><td><code>frontend</code></td><td><code>luksamuk/minerva_frontend:latest</code></td></tr>
<tr><td><code>rest</code></td><td><code>luksamuk/minerva_rest:latest</code></td></tr>
<tr><td><code>runonce</code></td><td><code>luksamuk/minerva_runonce:latest</code></td></tr>
<tr><td><code>user</code></td><td><code>luksamuk/minerva_user:latest</code></td></tr>
<tr><td><code>session</code></td><td><code>luksamuk/minerva_session:latest</code></td></tr>
<tr><td><code>pgadmin</code></td><td><code>luksamuk/minerva_pgadmin:latest</code></td></tr>
<tr><td><code>postgresql</code></td><td><code>postgres:14</code> (Não gerado)</td></tr>
<tr><td><code>mongodb</code></td><td><code>mongo:5</code> (Não gerado)</td></tr>
</tbody></table>
<h2 id="subindo-imagens-para-o-dockerhub"><a class="header" href="#subindo-imagens-para-o-dockerhub">Subindo imagens para o DockerHub</a></h2>
<p>Para enviar uma imagem para o DockerHub, primeiro é necessário se certificar de
que essa imagem possua uma <em>tag</em> adequada.</p>
<p>Em seguida, poderemos enviar todas as tags das imagens para o DockerHub.</p>
<pre><code class="language-bash">docker image push -a luksamuk/minerva_frontend
docker image push -a luksamuk/minerva_rest
docker image push -a luksamuk/minerva_runonce
docker image push -a luksamuk/minerva_user
docker image push -a luksamuk/minerva_session
docker image push -a luksamuk/minerva_pgadmin
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy"><a class="header" href="#deploy">Deploy</a></h1>
<p>As sessões a seguir tratarão do deploy da aplicação, ou mais especificamente, de
formas escaláveis de subir a aplicação num ambiente que simule produção.</p>
<p>Este capítulo trata de três tipos específicos de deploy:</p>
<ul>
<li>Usando Docker Compose;</li>
<li>Usando Docker Swarm;</li>
<li>Usando Kubernetes, através do Minikube.</li>
</ul>
<p>O Docker Compose poderá ser utilizado em situações de teste e desenvolvimento,
especialmente porque seu arquivo de configuração sempre aponta para a imagem
com tag <code>latest</code> de todos os contêineres (o que significa que utilizará
as imagens que tiverem sido recém-geradas na máquina).</p>
<p>O Docker Swarm trabalha de forma similar ao Compose em sua configuração, porém
utilizaremos a ferramenta <code>docker stack</code>, além de certa configuração manual,
para subir um cluster com <code>docker-machine</code>, que pode também ser configurado de
forma doméstica. A configuração poderá então ser usada para orquestração de
contêineres.</p>
<p>Já o Kubernetes, utilizando uma máquina virtual KVM2 através do Minikube,
possibilita uma orquestração de contêineres ainda mais flexível. Esta configuração
é utilizada também para um ambiente local, mas será a forma mais próxima de
colocar o sistema em produção.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy-usando-docker-compose"><a class="header" href="#deploy-usando-docker-compose">Deploy usando Docker Compose</a></h1>
<center>
<img src="./docker-compose.png" alt="Docker Compose" width="350"/>
</center>
<p>Você pode realizar deploy do projeto usando Docker Compose. Todavia,
esta não é a forma mais recomendada de realização de deploy.</p>
<h2 id="introdução-2"><a class="header" href="#introdução-2">Introdução</a></h2>
<p>Docker Compose é uma ferramenta simples de orquestração de contêineres.
Para o Minerva System, é principalmente uma forma de <strong>testar</strong> a forma
como o serviço se comporta em rede.</p>
<h2 id="objetivo-1"><a class="header" href="#objetivo-1">Objetivo</a></h2>
<p>O deploy usando Docker Compose é útil principalmente do ponto de vista
da geração das imagens das aplicações dos microsserviços do Minerva
System, mas também não é a forma mais recomendada de colocar o sistema
em produção, porque não prevê fatores de escalabilidade como o deploy
usando Kubernetes.</p>
<p>Utilize esta forma principalmente quando quiser avaliar o comportamento
do sistema no que tange a interconexões entre os serviços numa rede
virtual.</p>
<h2 id="dependências-1"><a class="header" href="#dependências-1">Dependências</a></h2>
<p>Você precisará ter:</p>
<ul>
<li>Docker versão 20.10 ou superior;</li>
<li>Docker Compose versão 2.2.3 ou superior;</li>
<li>As imagens do projeto (se não estiverem localmente disponíveis,
serão baixadas).</li>
</ul>
<p>Além disso, <strong>todos os comandos a seguir devem ser executados no
diretório raiz deste projeto</strong>.</p>
<h2 id="executando-os-serviços"><a class="header" href="#executando-os-serviços">Executando os serviços</a></h2>
<p>Para executar os serviços usando Docker Compose, use o seguinte
comando:</p>
<pre><code class="language-bash">docker compose up
</code></pre>
<p>Caso você queira desligar o funcionamento dos serviços da sessão
atual do console, poderá executá-los em forma de <em>daemon</em>:</p>
<pre><code class="language-bash">docker compose up -d
</code></pre>
<p>Neste caso em específico, para <code>localhost</code>, estarão abertas as
seguintes portas para acesso:</p>
<table><thead><tr><th>Porta</th><th>Serviço</th></tr></thead><tbody>
<tr><td><code>80</code></td><td>Front-End</td></tr>
<tr><td><code>9000</code></td><td>API REST</td></tr>
<tr><td><code>8484</code></td><td>pgAdmin4</td></tr>
</tbody></table>
<h2 id="acompanhando-logs"><a class="header" href="#acompanhando-logs">Acompanhando logs</a></h2>
<p>Para acompanhar os logs de um deploy via <em>daemon</em> ou de um outro
console, você poderá realizá-lo através do comando:</p>
<pre><code class="language-bash">docker compose logs -f
</code></pre>
<p>Caso seja necessário acompanhar os logs de apenas um serviço:</p>
<pre><code class="language-bash">docker compose logs -f &lt;servico&gt;
</code></pre>
<p>Lembre-se de que o nome do serviço em questão deverá ser informado
como listado em <code>docker-compose.yml</code>.</p>
<h3 id="reiniciando-um-único-serviço"><a class="header" href="#reiniciando-um-único-serviço">Reiniciando um único serviço</a></h3>
<p>Você poderá reiniciar um único serviço, caso tenha recompilado a imagem
do mesmo, por exemplo.</p>
<p>Nesse caso, basta usar o seguinte comando:</p>
<pre><code class="language-bash">docker compose up -d --no-deps &lt;servico&gt;
</code></pre>
<p>Caso você queira incluir o passo de recompilação da imagem:</p>
<pre><code class="language-bash">docker compose up -d --no-deps --build &lt;servico&gt;
</code></pre>
<h2 id="encerrando-os-serviços"><a class="header" href="#encerrando-os-serviços">Encerrando os serviços</a></h2>
<p>Para encerrar imediatamente o serviço, execute o seguinte comando:</p>
<pre><code class="language-bash">docker compose down
</code></pre>
<p>Caso você queira também remover os volumes associados aos serviços
(por exemplo, nocaso do PostgreSQL e do pgAdmin), use este comando
em vez do anterior:</p>
<pre><code class="language-bash">docker compose -v down
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy-via-docker-swarm--hashcorp-vagrant"><a class="header" href="#deploy-via-docker-swarm--hashcorp-vagrant">Deploy via Docker Swarm + HashCorp Vagrant</a></h1>
<center>
<img src="./swarm-vagrant.png" alt="Docker Swarm + HashiCorp Vagrant" width="400"/>
</center>
<p>Além do deploy via Docker Compose, também é possível disponibilizar a stack do
Sistema Minerva em um <em>cluster</em> do Docker Swarm.</p>
<p>Para tanto, é necessário inicializar o cluster. Isso pode ser feito, por
exemplo, com máquinas virtuais para finalidade de teste (neste caso, pode ser
utilizado o VirtualBox para prover essa facilidade).</p>
<p>Nesse capítulo, veremos como fazer isso de forma automatizada através de uma
configuração do Vagrant. Essa configuração criará máquinas virtuais e também
inicializará o sistema no <em>cluster</em>.</p>
<h2 id="pré-requisitos-1"><a class="header" href="#pré-requisitos-1">Pré-requisitos</a></h2>
<ul>
<li>Vagrant versão 2.2.19 ou superior;</li>
<li>VirtualBox versão 6.1 ou superior.</li>
</ul>
<p>Você pode utilizar outro <em>provider</em> além de VirtualBox (como <code>libvirt</code>), mas
precisará alterar o arquivo <code>Vagrantfile</code>.</p>
<p><strong>NOTA:</strong> Qualquer comando do Vagrant deve ser executado no diretório <code>swarm</code>,
para que o Vagrant tenha acesso ao <code>Vagrantfile</code>.</p>
<h2 id="reinicializando-o-cluster"><a class="header" href="#reinicializando-o-cluster">Reinicializando o cluster</a></h2>
<p>Caso você já tenha iniciado o <em>cluster</em> com Vagrant, basta ir até o diretório
<code>swarm</code> e executar <code>vagrant up</code>. Isso reiniciará as máquinas virtuais, mas
também executará o <code>docker stack deploy</code> novamente para o arquivo de configuração,
o que forçará uma atualização em todos os serviços.</p>
<h2 id="criando-o-cluster"><a class="header" href="#criando-o-cluster">Criando o cluster</a></h2>
<p>Para criar o cluster, vá até o diretório <code>swarm</code> e execute o Vagrant.</p>
<pre><code class="language-bash">cd swarm
vagrant up
</code></pre>
<p>Isso utilizará o arquivo <code>Vagrantfile</code> para criar sete máquinas virtuais
(dois <em>managers</em> e dois <em>workers</em>), e também realizará automaticamente o
<em>deploy</em> do sistema Minerva usando o arquivo <code>docker-stack.yml</code>.</p>
<p>Alguns arquivos extras serão criados na pasta. Eles dizem respeito respectivamente
ao IP do primeiro gerente e aos tokens de ingresso no <em>cluster</em> para gerentes
e trabalhadores.</p>
<p>Em geral, a relação das máquinas virtuais do <em>cluster</em> será:</p>
<ul>
<li><code>manager01</code>: <em>Manager</em>, líder, inicializador original dos serviços;</li>
<li><code>manager02</code> e <code>manager03</code>: <em>Managers</em> adicionais;</li>
<li><code>worker01</code> a <code>worker04</code>: <em>Workers</em>.</li>
</ul>
<p>Para verificar o formato do <em>cluster</em> e as informações acima, use o comando:</p>
<pre><code class="language-bash">vagrant status
</code></pre>
<h2 id="fazendo-deploy-do-sistema-minerva"><a class="header" href="#fazendo-deploy-do-sistema-minerva">Fazendo deploy do Sistema Minerva</a></h2>
<p>Caso você realize modificações no arquivo <code>docker-stack.yml</code>, poderá
querer fazer <em>deploy</em> novamente dos serviços de forma manual.</p>
<p>Para tanto, entre em qualquer um dos <em>managers</em> via SSH. Por exemplo, para
o primeiro <em>manager</em>:</p>
<pre><code class="language-bash">vagrant ssh manager01
</code></pre>
<p>O diretório <code>swarm</code> fica montado dentro de todas as máquinas virtuais em
<code>/vagrant</code> (que é mutável apenas durante a criação do <em>cluster</em>). Todavia,
você ainda poderá modificar os arquivos no <em>host</em> e terá acesso a eles.</p>
<p>Para aplicar manualmente o arquivo <code>docker-stack.yml</code>:</p>
<pre><code class="language-bash"># Em manager01
docker stack deploy --compose-file /vagrant/docker-stack.yml minerva
</code></pre>
<h3 id="gerenciando-a-stack"><a class="header" href="#gerenciando-a-stack">Gerenciando a stack</a></h3>
<p>Podemos gerenciar a stack facilmente dentro de uma VM manager.</p>
<p>Para listar as stacks ativas:</p>
<pre><code class="language-bash"># Em manager01
docker stack ls
</code></pre>
<p>Se quisermos observar os serviços de uma stack em específico:</p>
<pre><code class="language-bash"># Em manager01
docker stack services minerva
</code></pre>
<p>Ou, em último caso, se quisermos remover uma stack:</p>
<pre><code class="language-bash"># Em manager01
docker stack rm minerva
</code></pre>
<h3 id="acessando-os-serviços"><a class="header" href="#acessando-os-serviços">Acessando os serviços</a></h3>
<p>Os serviços que podem ser acessados de forma externa estarão disponíveis
normalmente assim como no Docker Compose, porém sob um IP diferente.</p>
<p>Por padrão, todos os <em>managers</em> possuem um IP começado com <code>172.20.20.1X</code>,
algo definido através do <code>Vagrantfile</code>. Os <em>workers</em> terão um IP
iniciado com <code>172.20.20.10X</code>. A variável <code>X</code> será sempre um número
contado a partir de <code>1</code>; por exemplo, o <code>manager01</code> possuirá um IP
necessariamente igual a <code>172.20.20.11</code>.</p>
<p>Para acessar os serviços, use qualquer IP do <em>cluster</em>. A descoberta
do serviço será realizada através do <em>routing mesh</em> do Docker Swarm.</p>
<p>Abaixo, temos uma relação das portas utilizadas para cada um dos serviços
disponíveis no <em>cluster</em>.</p>
<table><thead><tr><th>Porta</th><th>Descrição</th></tr></thead><tbody>
<tr><td>80</td><td>Front-end</td></tr>
<tr><td>9000</td><td>API REST</td></tr>
<tr><td>8484</td><td>PgAdmin 4</td></tr>
<tr><td>8585</td><td>Visualizador do cluster</td></tr>
</tbody></table>
<h2 id="encerrando-o-serviço"><a class="header" href="#encerrando-o-serviço">Encerrando o serviço</a></h2>
<p>Para encerrar todas as máquinas virtuais sem perder o estado das
mesmas, use:</p>
<pre><code class="language-bash">vagrant suspend
</code></pre>
<p>Ou, se você desejar destruir o <em>cluster</em> completamente:</p>
<pre><code class="language-bash">vagrant destroy -f
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy-via-docker-swarm--docker-machine"><a class="header" href="#deploy-via-docker-swarm--docker-machine">Deploy via Docker Swarm + Docker Machine</a></h1>
<center>
<img src="./docker-swarm.png" alt="Docker Swarm" width="200"/>
</center>
<p>Outra forma de realizar <em>deploy</em> usando o Docker Swarm é através do Docker
Machine, um utilitário capaz de criar máquinas virtuais com Docker já
instalado a partir de uma imagem Linux especial.</p>
<p>O Docker Machine é uma ferramenta defasada, mas pode ser uma alternativa quando
for do interesse do programador fazer um trabalho mais manual. Por ser o método
utilizado antes do uso do Vagrant, esta página existe como referência ao uso
da ferramenta.</p>
<h2 id="pré-requisitos-2"><a class="header" href="#pré-requisitos-2">Pré-requisitos</a></h2>
<ul>
<li>Docker Machine versão 0.16.2;</li>
<li>VirtualBox versão 6.1 ou superior.</li>
</ul>
<h3 id="instalando-o-docker-machine-no-linux"><a class="header" href="#instalando-o-docker-machine-no-linux">Instalando o Docker Machine no Linux</a></h3>
<p>Como o Docker Machine é uma ferramenta defasada, é necessário executar
passos como os a seguir para instalar:</p>
<pre><code class="language-bash">base=https://github.com/docker/machine/releases/download/v0.16.2
curl -L $base/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine
sudo install /tmp/docker-machine /usr/local/bin/docker-machine
</code></pre>
<p>Para instalar os drivers de KVM2, caso você prefira utilizá-los:</p>
<pre><code class="language-bash">base=https://github.com/praveenkumar/machine-kvm2-driver/releases/download/v0.11.0
curl -L $base/docker-machine-driver-kvm2 &gt;/tmp/docker-machine-driver-kvm2
sudo install /tmp/docker-machine-driver-kvm2 /usr/local/bin/docker-machine-driver-kvm2
</code></pre>
<h2 id="reinicializando-o-cluster-1"><a class="header" href="#reinicializando-o-cluster-1">Reinicializando o cluster</a></h2>
<p>Caso você já tenha construído um cluster e feito <em>deploy</em> via Docker Machine
anteriormente, é bem provável que você não precise fazer a maioria do trabalho.
Você poderá simplesmente reiniciar as máquinas virtuais:</p>
<pre><code class="language-bash">docker-machine start `docker-machine ls &quot;minerva-*&quot; -q`
</code></pre>
<p>Existe a possibilidade de as máquinas virtuais não conseguirem se reconhecer
por uma mudança de IP. Se isso ocorrer, reconfigure o <em>cluster</em> manualmente,
gerando os <em>tokens</em> para cada máquina virtual e inserindo-as no <em>cluster</em>.</p>
<h2 id="criando-o-cluster-1"><a class="header" href="#criando-o-cluster-1">Criando o cluster</a></h2>
<p>Se você ainda não tiver um <em>cluster</em> criado, poderá criar o <em>cluster</em> através
da ferramenta Docker Machine. Comece criando uma máquina virtual chamada
<code>minerva-vm1</code>, que será nosso inicializador do <em>cluster</em>.</p>
<pre><code class="language-bash">docker-machine create -d virtualbox --swarm-master minerva-vm1
</code></pre>
<h3 id="iniciando-o-cluster"><a class="header" href="#iniciando-o-cluster">Iniciando o cluster</a></h3>
<p>Vamos começar iniciando o Docker Swarm na primeira máquina virtual.</p>
<p>Para acessar o console de uma máquina virtual via SSH, use também o Docker
Machine para isso.</p>
<pre><code class="language-bash">docker-machine ssh minerva-vm1
</code></pre>
<p>Para iniciar o cluster, precisamos descobrir também o IP dessa máquina virtual.
Você poderá ver o IP de uma máquina virtual em específico via Docker Machine
também, em outro console:</p>
<pre><code class="language-bash">docker-machine ip minerva-vm1
</code></pre>
<p>Voltando ao console da VM, vamos iniciar o Docker Swarm.</p>
<pre><code class="language-bash"># Em minerva-vm1
docker swarm init --advertise-addr &lt;IP&gt;
</code></pre>
<h3 id="criando-mais-managers"><a class="header" href="#criando-mais-managers">Criando mais managers</a></h3>
<p>Uma arquitetura básica de managers e workers do Swarm, para que o algoritmo de
consenso RAFT opere como esperado, poderia envolver três managers e dois workers
-- portanto, cinco máquinas virtuais.</p>
<p>Vamos criar mais duas máquinas virtuais que vão servir de managers (<code>minerva-vm2</code>
e <code>minerva-vm3</code>):</p>
<pre><code class="language-bash">docker-machine create -d virtualbox --swarm-master minerva-vm2
docker-machine create -d virtualbox --swarm-master minerva-vm3
</code></pre>
<p>Para adicionar essas VMs no <em>cluster</em>, vamos obter o token de entrada no <em>cluster</em>
para managers, que será um mero comando do console. Copiamos esse comando e colamos
no console das duas máquinas virtuais recém-criadas.</p>
<pre><code class="language-bash"># Em minerva-vm1
docker swarm join-token manager

# Em minerva-vm2 e minerva-vm3: Cole o comando
docker swarm join --token...
</code></pre>
<h3 id="criando-workers"><a class="header" href="#criando-workers">Criando workers</a></h3>
<p>Criaremos mais duas máquinas virtuais com o Swarm preparado, mas dessa vez, vamos
prepará-las para serem meros workers:</p>
<pre><code class="language-bash">docker-machine create -d virtualbox --swarm minerva-vm4
docker-machine create -d virtualbox --swarm minerva-vm5
</code></pre>
<p>O princípio para adicionar workers no <em>cluster</em> é o mesmo, porém usaremos um comando
diferente para gerar o token. Geramos esse comando, copiamos e colamos no console
das VMs <code>minerva-vm4</code> e <code>minerva-vm5</code>.</p>
<pre><code class="language-bash"># Em minerva-vm1
docker swarm join-token worker

# Em minerva-vm4 e minerva-vm5: Cole o comando
docker swarm join --token...
</code></pre>
<h3 id="verificando-a-topologia-do-cluster"><a class="header" href="#verificando-a-topologia-do-cluster">Verificando a topologia do cluster</a></h3>
<p>Vamos verificar a topologia do <em>cluster</em>. Podemos observar a atividade das máquinas
virtuais diretamente através do Docker Machine:</p>
<pre><code class="language-bash">docker-machine ls
</code></pre>
<pre><code>NAME          ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER      ERRORS
minerva-vm1   -        virtualbox   Running   tcp://192.168.99.108:2376           v19.03.12
minerva-vm2   -        virtualbox   Running   tcp://192.168.99.109:2376           v19.03.12
minerva-vm3   -        virtualbox   Running   tcp://192.168.99.110:2376           v19.03.12
minerva-vm4   -        virtualbox   Running   tcp://192.168.99.111:2376           v19.03.12
minerva-vm5   -        virtualbox   Running   tcp://192.168.99.112:2376           v19.03.12
</code></pre>
<p>Para avaliarmos o <em>cluster</em> em si e a forma como os nós se conectam, poderemos ver a
topologia dos nós diretamente dentro da primeira VM:</p>
<pre><code class="language-bash"># Em minerva-vm1
docker node ls
</code></pre>
<pre><code>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
exgmsiju6pnrl01tt33n5guui *   minerva-vm1         Ready               Active              Leader              19.03.12
cpxtnhalvu9tat9ek4n1n0117     minerva-vm2         Ready               Active              Reachable           19.03.12
p2v7v8ac93wuhwhcdsjl00p8y     minerva-vm3         Ready               Active              Reachable           19.03.12
jihrf6wgm145xzr0pdb6tnrck     minerva-vm4         Ready               Active                                  19.03.12
b1wfgme22m14pmjceo8ktn1hj     minerva-vm5         Ready               Active                                  19.03.12
</code></pre>
<p>Outra opção interessante é acompanhar também os serviços e os contêineres criados:</p>
<pre><code class="language-bash"># Em minerva-vm1
docker service ls
docker container ls
</code></pre>
<h3 id="fazendo-backup-do-cluster"><a class="header" href="#fazendo-backup-do-cluster">Fazendo backup do cluster</a></h3>
<p>Caso você queira fazer backup da topologia do <em>cluster</em>, lembre-se de copiar o
diretório <code>/var/lib/docker/swarm</code> em <code>minerva-vm1</code>.</p>
<pre><code class="language-bash"># Em minerva-vm1
sudo cp -r /var/lib/docker/swarm ./swarm
sudo chown -R $USER ./swarm

# No host
docker-machine scp -r minerva-vm1:/home/docker/swarm localhost:~/swarm-backup
</code></pre>
<h2 id="fazendo-deploy-do-sistema-minerva-1"><a class="header" href="#fazendo-deploy-do-sistema-minerva-1">Fazendo deploy do Sistema Minerva</a></h2>
<p>Para fazer <em>deploy</em> do sistema, dado que o <em>cluster</em> esteja configurado, basta
reutilizar o arquivo preparado para isso no repositório do Sistema Minerva.</p>
<p>Copiamos o arquivo para dentro da VM principal e então realizamos deploy:</p>
<pre><code class="language-bash">docker-machine scp localhost:./swarm/docker-stack.yml minerva-vm1:/home/docker/docker-stack.yml

# Em minerva-vm1
docker stack deploy --compose-file docker-stack.yml minerva
</code></pre>
<h3 id="gerenciando-a-stack-1"><a class="header" href="#gerenciando-a-stack-1">Gerenciando a stack</a></h3>
<p>Podemos gerenciar a stack facilmente dentro de uma VM manager.</p>
<p>Para listar as stacks ativas:</p>
<pre><code class="language-bash"># Em minerva-vm1
docker stack ls
</code></pre>
<p>Se quisermos observar os serviços de uma stack em específico:</p>
<pre><code class="language-bash"># Em minerva-vm1
docker stack services minerva
</code></pre>
<p>Ou, em último caso, se quisermos remover uma stack:</p>
<pre><code class="language-bash"># Em minerva-vm1
docker stack rm minerva
</code></pre>
<h3 id="acessando-os-serviços-1"><a class="header" href="#acessando-os-serviços-1">Acessando os serviços</a></h3>
<p>Para visualizar os serviços, primeiro visualize o IP das Docker Machines:</p>
<pre><code class="language-bash">docker-machine ls
</code></pre>
<p>É possível usar o IP de qualquer Docker Machine, neste ponto. Basta utilizar
as portas certas:</p>
<table><thead><tr><th>Porta</th><th>Descrição</th></tr></thead><tbody>
<tr><td>80</td><td>Front-end</td></tr>
<tr><td>9000</td><td>API REST</td></tr>
<tr><td>8484</td><td>PgAdmin 4</td></tr>
<tr><td>8585</td><td>Visualizador do cluster</td></tr>
</tbody></table>
<h2 id="encerrando-o-serviço-1"><a class="header" href="#encerrando-o-serviço-1">Encerrando o serviço</a></h2>
<p>Caso você queira parar todas as máquinas virtuais, use o comando a seguir:</p>
<pre><code class="language-bash">docker-machine stop `docker-machine ls &quot;minerva-*&quot; -q`
</code></pre>
<p>Ou, se você quiser remover realmente as máquinas virtuais:</p>
<pre><code class="language-bash">docker-machine rm `docker-machine ls &quot;minerva-*&quot; -q`
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy-usando-kubernetes-e-minikube"><a class="header" href="#deploy-usando-kubernetes-e-minikube">Deploy usando Kubernetes (e Minikube)</a></h1>
<center>
<img src="./kubernetes-logo.webp" alt="Kubernetes" width="200"/>
</center>
<p>Você pode realizar deploy do projeto usando Kubernetes. Nos passos a
seguir, será mostrado como realizar um deploy usando a ferramenta
Minikube, para instalação do Kubernetes localmente.</p>
<p><strong>ATENÇÃO:</strong> Para detalhes não dispostos nesta página, veja a
<a href="https://kubernetes.io/docs/home/">documentação oficial do Kubernetes</a>.</p>
<h2 id="introdução-3"><a class="header" href="#introdução-3">Introdução</a></h2>
<p>Kubernetes é uma ferramenta sofisticada de orquestração de contêineres.
O Minerva System é planejado para que seu deploy seja feito utilizando
o Kubernetes.</p>
<p>Para realizar a configuração localmente, fui utilizada a ferramenta
Minikube. Portanto, os comandos aqui abordados partem do pressuposto
de uma instalação local do Kubernetes via Minikube, e podem ser </p>
<h2 id="objetivo-2"><a class="header" href="#objetivo-2">Objetivo</a></h2>
<p>O deploy usando Kubernetes é planejado desde o início do projeto, sendo
uma das formas de estado da arte de deploy de aplicações web. Para
simular este cenário, utilizamos uma instalação local do Kubernetes
via Minikube.</p>
<p>Ainda que Minikube não seja exatamente um servidor do Kubernetes em
produção, boa parte do que será aqui discutido poderá ser utilizado
no momento do deploy para produção.</p>
<h2 id="dependências-2"><a class="header" href="#dependências-2">Dependências</a></h2>
<p>Você precisará ter instalado:</p>
<ul>
<li>Docker versão 20.10 ou superior;</li>
<li>Docker Compose versão 2.2.3 ou superior;</li>
<li>Kubectl versão 1.23.3 ou superior;</li>
<li><a href="https://minikube.sigs.k8s.io/docs/">Minikube</a> versão 1.24.0 ou
superior;</li>
<li><a href="k9scli.io">k9s</a> versão 0.25.18 ou superior (opcional).</li>
</ul>
<p>A instalação do k9s é opcional, sendo uma ferramenta de monitoramento
e gerencialmento do Kubernetes via linha de comando.</p>
<h3 id="iniciando-o-minikube"><a class="header" href="#iniciando-o-minikube">Iniciando o Minikube</a></h3>
<p>Caso você esteja testando localmente, comece executando o Minikube.</p>
<p>As configurações a seguir iniciam um cluster local via Minikube, usando
KVM2 como backend. Você poderá também usar os backends <code>docker</code> ou
<code>virtualbox</code>, à escolha.</p>
<pre><code class="language-bash">minikube start \
	--vm-driver=kvm2 \
	--disable-optimizations=false \
	--extra-config=kubelet.housekeeping-interval=10s

minikube addons enable metrics-server
minikube addons enable ingress
minikube addons enable ingress-dns
</code></pre>
<p>Se você quiser parar o Minikube:</p>
<pre><code class="language-bash">minikube stop
</code></pre>
<p>Igualmente, se quiser remover o cluster:</p>
<pre><code class="language-bash">minikube delete --all
</code></pre>
<h3 id="problemas-com-libvirt-e-apparmor"><a class="header" href="#problemas-com-libvirt-e-apparmor">Problemas com Libvirt e AppArmor</a></h3>
<p>Caso você tenha problemas para inicializar a máquina virtual com KVM2,
pode ser que sua instalação local do AppArmor esteja interferindo com
o <code>libvirt</code>.</p>
<p>Como ferramenta paliativa à configuração do AppArmor para o <code>libvirt</code>,
você poderá colocar os utilitários usados pelo Minikube no modo <em>complain</em>.
Lembre-se de que isso é necessariamente detrimental à segurança do sistema.</p>
<pre><code class="language-bash">sudo aa-complain /usr/sbin/libvirtd
sudo aa-complain /usr/libexec/virt-aa-helper
</code></pre>
<h2 id="estrutura-do-cluster"><a class="header" href="#estrutura-do-cluster">Estrutura do Cluster</a></h2>
<p>A seguir, trataremos da estrutura do cluster como atualmente é definido.
As seções a seguir tratam sempre de objetos específicos do Kubernetes,
e são também uma sugestão de ordem de aplicação dos arquivos de configuração.</p>
<p>Todos os arquivos serão encontrados de forma homônima no diretório <code>deploy</code>,
com a extensão <code>yml</code>.</p>
<p>Caso queira aplicar todos os arquivos enumerados abaixo, simplesmente execute:</p>
<pre><code class="language-bash">kubectl apply -f deploy
</code></pre>
<h3 id="configmaps"><a class="header" href="#configmaps"><em>ConfigMaps</em></a></h3>
<p>Um <em>ConfigMap</em> é um objeto que armazena dados que serão utilizados como
variáveis de ambiente de um <em>pod</em>.</p>
<ul>
<li><code>postgresql-configmap</code>: Variáveis padrão para definições iniciais do
PostgreSQL 14.</li>
<li><code>mongodb-configmap</code>: Variáveis padrão para definições iniciais do
MongoDB 5.</li>
<li><code>runonce-configmap</code>: Variáveis padrão para definições iniciais do
Job RUNONCE.</li>
<li><code>frontend-configmap</code>: Variáveis padrão para uso do Front-End.</li>
<li><code>rest-configmap</code>: Variáveis padrão para a API REST.</li>
<li><code>ports-configmap</code>: Portas para acesso aos serviços no cluster.</li>
<li><code>servers-configmap</code>: Nomes dos serviços a serem acessados. Geralmente
associados a cada Deployment ou StatefulSet;</li>
<li><code>redis-configmap</code>: Dados de configuração do Redis. Mais especificamente
um arquivo <code>redis.conf</code> que será recuperado nos <em>pods</em> do Redis através
da montagem desse <em>ConfigMap</em>, como se fosse um volume mutável.</li>
</ul>
<p>Para aplicar todos os <em>ConfigMaps</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-configmap.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="persistentvolumeclaims"><a class="header" href="#persistentvolumeclaims"><em>PersistentVolumeClaims</em></a></h3>
<p>Um <em>PersistentVolumeClaim</em> age como uma reserva de volume persistente
(<em>PersistentVolume</em>). Pode associar-se a um volume que exista ou, neste
caso, cria um volume com tamanho específico dinamicamente.</p>
<ul>
<li><code>postgresql-pvc</code>: PersistentVolumeClaim para o PostgreSQL. Solicita 1GB
de armazenamento e criação dinâmica;</li>
<li><code>mongodb-pvc</code>: PersistentVolumeClaim para o MongoDB. Solicita 1GB de
armazenamento e criação dinâmica;</li>
<li><code>redis-pvc</code>: PersistentVolumeClaim para o Redis. Solicita 500MB de
armazenamento e criação dinâmica.</li>
</ul>
<p>Para aplicar todos os <em>PersistentVolumeClaims</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-pvc.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="deployments"><a class="header" href="#deployments"><em>Deployments</em></a></h3>
<p>Um <em>Deployment</em> é uma forma de gerenciar <em>pods</em> e suas réplicas. Mais
especificamente, trata-se de uma evolução de um <em>ReplicaSet</em> que permite
a utilização de versionamento.</p>
<ul>
<li><code>postgresql-deployment</code>: Deployment para o banco de dados PostgreSQL.</li>
<li><code>mongodb-deployment</code>: Deployment para o banco de dados MongoDB.</li>
<li><code>frontend-deployment</code>: Deployment para o Front-End Web do sistema.</li>
<li><code>rest-deployment</code>: Deployment para o gateway REST do sistema.</li>
<li><code>user-deployment</code>: Deployment para o microsserviço <code>USER</code>.</li>
<li><code>session-deployment</code>: Deployment para o microsserviço <code>SESSION</code>.</li>
</ul>
<p>Para aplicar todos os <em>Deployments</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-deployment.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="statefulsets"><a class="header" href="#statefulsets"><em>StatefulSets</em></a></h3>
<p>Um <em>StatefulSet</em> é exatamente igual a um <em>Deployment</em>, porém seus <em>pods</em>
são criados com nomes ordinais em vez de aleatórios, de forma que possam
ser individualmente identificados. Além disso, <em>StatefulSets</em> devem ser
utilizados quando o estado interno da aplicação importa.</p>
<ul>
<li><code>redis-statefulset</code>: StatefulSet para o cluster do serviço de
cache do Redis. A réplica <code>redis-0</code> será sempre um <em>Master</em>, enquanto
as demais réplicas serão sempre <em>Slaves</em>.</li>
</ul>
<p>Para aplicar todos os <em>StatefulSets</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-statefulset.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="services"><a class="header" href="#services"><em>Services</em></a></h3>
<p>Um <em>Service</em> determina a conexão de um ou mais <em>pods</em> com o restante do
cluster ou com a internet. <em>Services</em> podem ser do tipo <em>ClusterIP</em>,
<em>NodePort</em> ou <em>LoadBalancer</em>. O primeiro tipo expõe os <em>pods</em> apenas para
outros <em>pods</em> do cluster; o segundo e o terceiro expõem para a internet,
com a diferença que um <em>LoadBalancer</em> é a maneira padrão de exposição por
integrar-se com o balanceador de recursos do provedor do cluster.</p>
<p>Além disso, serviços do tipo <em>LoadBalancer</em> agem retroativamente como
<em>NodePort</em>, e estes agem também retroativamente como <em>ClusterIP</em>.</p>
<ul>
<li><code>postgresql-svc</code> (<em>ClusterIP</em>): Serviço para acesso interno aos pods
PostgreSQL.</li>
<li><code>mongodb-svc</code> (<em>ClusterIP</em>): Serviço para acesso interno aos pods
MongoDB.</li>
<li><code>user-svc</code> (<em>ClusterIP</em>): Serviço para acesso interno aos pods do
microsserviço USER.</li>
<li><code>session-svc</code> (<em>ClusterIP</em>): Serviço para acesso interno aos pods do
microsserviço SESSION.</li>
<li><code>frontend-svc</code> (<em>LoadBalancer</em>): Serviço para acesso interno e externo
aos pods do Front-End Web do sistema. Exposto na porta <code>30001</code>.</li>
<li><code>rest-svc</code> (<em>LoadBalancer</em>): Serviço para acesso interno e externo aos
pods do gateway REST do sistema. Exposto na porta <code>30000</code>.</li>
<li><code>redis-svc</code> (<em>ClusterIP</em>): Serviço para acesso interno aos pods do
Redis.</li>
</ul>
<p>Para aplicar todos os <em>Services</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-svc.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="jobs"><a class="header" href="#jobs"><em>Jobs</em></a></h3>
<p>Um <em>Job</em> é responsável por criar um <em>pod</em> que executará alguma ação, até
seu completamento ser realizado com sucesso.</p>
<ul>
<li><code>runonce-job</code>: Job a ser executado no início do deploy do cluster, para
configuração inicial. Reiniciará o <em>pod</em> em caso de falhas dez vezes e,
após sucesso, será removido junto com o <em>pod</em> após cinco minutos.</li>
</ul>
<p>Para aplicar todos os <em>ConfigMaps</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-job.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="horizontalpodautoscalers"><a class="header" href="#horizontalpodautoscalers">HorizontalPodAutoscalers</a></h3>
<ul>
<li><code>rest-hpa</code>: Escalonador horizontal do gateway REST. Mantém entre 1 e
15 réplicas para <code>rest-deployment</code> com uso médio de 50% do CPU alocado.</li>
<li><code>user-hpa</code>: Escalonador horizontal do microsserviço USER. Mantém entre
2 e 6 réplicas para <code>user-deployment</code> com uso médio de 65% do CPU alocado.</li>
<li><code>session-hpa</code>: Escalonador horizontal do microsserviço SESSION. Mantém
entre 2 e 6 réplicas para <code>session-deployment</code> com uso médio de 65%
do CPU alocado.</li>
<li><code>redis-hpa</code>: Escalonador horizontal do Redis. Mantém entre 2 e 15
réplicas para <code>redis-statefulset</code> com uso médio de 50% do CPU alocado e
60% da memória alocada.</li>
</ul>
<p>Para aplicar todos os <em>HorizontalPodAutoscalers</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-hpa.yml`; do kubectl apply -f $f; done
</code></pre>
<h3 id="ingresses"><a class="header" href="#ingresses"><em>Ingresses</em></a></h3>
<p>Um <em>Ingress</em> é um objeto responsável por gerenciar acesso externo a
serviços no cluster, tipicamente via HTTP.</p>
<ul>
<li><code>api-ingress</code>: Ponto de entrada para a API através do URL
<code>http://minerva-system.io</code>. Expõe a API em <code>/api</code>.</li>
<li><code>frontend-ingress</code>: Ponto de entrada para o Front-End através do URL
<code>http://minerva-system.io</code>. Expõe o Front-End em <code>/</code>.</li>
</ul>
<p>Para aplicar todos os <em>Ingresses</em>, execute:</p>
<pre><code class="language-bash">for f in `ls deploy/*-ingress.yml`; do kubectl apply -f $f; done
</code></pre>
<h2 id="acesso-via-nodeport"><a class="header" href="#acesso-via-nodeport">Acesso via NodePort</a></h2>
<p>Para acessar os serviços expostos via <em>NodePort</em> (ou <em>LoadBalancer</em>) no
cluster, diretamente através do IP do Minikube, primeiramente verifique
o endereço IP do cluster. Isso pode ser feito via Kubectl:</p>
<pre><code class="language-bash">kubectl get node -o wide
</code></pre>
<p>Isso pode também ser feito através do Minikube:</p>
<pre><code class="language-bash">minikube ip
</code></pre>
<p>Você poderá acessar os serviços através deste mesmo IP, através das portas
<code>30000</code> (API REST) ou <code>30001</code> (Front-End).</p>
<h2 id="acesso-via-ingress"><a class="header" href="#acesso-via-ingress">Acesso via Ingress</a></h2>
<p>Outra forma de acessar envolve o uso dos objetos <em>Ingress</em>. Isso nos
permitirá usar o endereço <code>http://minerva-system.io/</code> como URL base
do sistema.</p>
<p>Garanta que o addon <code>ingress</code> esteja habilitado.</p>
<p>Agora, descubra o IP do Minikube na máquina:</p>
<pre><code class="language-bash">minikube ip
</code></pre>
<p>Finalmente, edite o arquivo <code>/etc/hosts</code> e adicione o seguinte:</p>
<pre><code>&lt;ip-do-minikube&gt;	minerva-system.io
</code></pre>
<p>O Front-End agora poderá ser acessado em <code>http://minerva-system.io/</code>,
e a API poderá ser acessada em <code>http://minerva-system.io/api</code>.</p>
<h3 id="usando-o-dns-de-ingress-do-minikube"><a class="header" href="#usando-o-dns-de-ingress-do-minikube">Usando o DNS de Ingress do Minikube</a></h3>
<p>Você poderá também usar o Minikube como servidor DNS, evitando de inserir
o URL diretamente em <code>/etc/hosts</code>.</p>
<p>Comece garantindo que os addons <code>ingress</code> e <code>ingress-dns</code> estejam
habilitados. Em seguida, descubra o IP do Minikube:</p>
<pre><code class="language-bash">minikube ip
</code></pre>
<p>O Minikube possui uma vasta documentação a respeito de como configurar esse
DNS, mas mostrarei como fazê-lo caso você utiliza SystemD e tiver o ResolveD
instalado (como é o caso de uma instalação pura com Fedora 36).</p>
<p>Edite o arquivo <code>/etc/systemd/resolved.conf</code>. Supondo que você use o DNS
do Google, por exemplo, insira o IP do Minikube no DNS e configure um FallbackDNS
também:</p>
<pre><code class="language-conf">[Resolve]
DNS=192.168.39.97 8.8.8.8
FallbackDNS=8.8.4.4
</code></pre>
<p>Em seguida, reinicie o ResolveD:</p>
<pre><code class="language-bash">sudo systemctl restart systemd-resolved
</code></pre>
<p>Pode ser que a conexão com os demais serviços da internet fiquem ligeiramente
instáveis, <em>enquanto o Minikube estiver em execução</em>.</p>
<p>Você poderá verificar se funciona adequadamente com o comando:</p>
<pre><code class="language-bash">nslookup minerva-system.io
</code></pre>
<h2 id="monitorando-via-k9s"><a class="header" href="#monitorando-via-k9s">Monitorando via k9s</a></h2>
<p><img src="./k9s.png" alt="k9s" /></p>
<p>Uma das ferramentas possíveis de se utilizar para monitorar o cluster
é o <code>k9s</code>.</p>
<p>A ferramenta utiliza uma edição modal, muito parecida com o editor
Vim. Os comandos possuem um sistema de autocompletar e são também
mostrados na tela. Alguns comandos interessantes de serem utilizados
são:</p>
<ul>
<li><code>:q</code>: Sair da aplicação.</li>
<li><code>:po</code>: Lista de <em>Pods</em>.</li>
<li><code>:svc</code>: Lista de <em>Services</em>.</li>
<li><code>:dp</code>: Lista de <em>Deployments</em>.</li>
<li><code>:ing</code>: Lista de <em>Ingresses</em>.</li>
<li><code>:hpa</code>: Lista de <em>HorizontalPodAutoscalers</em>.</li>
<li><code>:pvc</code>: Lista de <em>PersistentVolumeClaims</em>.</li>
<li><code>:pv</code>: Lista de <em>PersistentVolumes</em>.</li>
</ul>
<p>Você poderá usar o <code>k9s</code> para visualizar logs e também para modificar
algumas propriedades mais avançadas também. É possível até mesmo acessar
diretamente o console dos contêineres.</p>
<h2 id="monitorando-via-dashboard"><a class="header" href="#monitorando-via-dashboard">Monitorando via dashboard</a></h2>
<p>Você também pode acessar facilmente um dashboard web do Kubernetes,
operando sob o Minikube, caso não queira usar o <code>k9s</code> posteriormente
(lembre-se de que objetos como <em>HorizontalPodAutoscaler</em> não são
visíveis nesse Dashboard):</p>
<pre><code class="language-bash">minikube dashboard
</code></pre>
<h2 id="testes-de-stress"><a class="header" href="#testes-de-stress">Testes de Stress</a></h2>
<p>Para realizar testes de stress, use o script <code>deploy/stress_test.sh</code>.
Você poderá testar cada sistema crucial usando um comando como este:</p>
<pre><code class="language-bash">./deploy/stress_test.sh minerva-system.io/api user
</code></pre>
<p>Para maiores informações, execute o script sem argumentos.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estrutura-geral-do-cluster-kubernetes"><a class="header" href="#estrutura-geral-do-cluster-kubernetes">Estrutura geral do cluster Kubernetes</a></h1>
<p>O diagrama a seguir mostra a estrutura geral do cluster em Kubernetes.</p>
<p>Última atualização: 27/06/2022</p>
<center>
<p><img src="diagramas/kubernetes.png" alt="Estrutura geral do cluster Kubernetes" /></p>
</center>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
